<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Matthew Hoctor, PharmD">
<meta name="dcterms.date" content="2024-05-18">
<title>Dataset - Geocoding to County</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="dataset_geo3_files/libs/clipboard/clipboard.min.js"></script>
<script src="dataset_geo3_files/libs/quarto-html/quarto.js"></script>
<script src="dataset_geo3_files/libs/quarto-html/popper.min.js"></script>
<script src="dataset_geo3_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="dataset_geo3_files/libs/quarto-html/anchor.min.js"></script>
<link href="dataset_geo3_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="dataset_geo3_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="dataset_geo3_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="dataset_geo3_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="dataset_geo3_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
</head>
<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li>
<a href="#datasets" id="toc-datasets" class="nav-link" data-scroll-target="#datasets">Datasets</a>
  <ul>
<li><a href="#load-data" id="toc-load-data" class="nav-link" data-scroll-target="#load-data">Load Data</a></li>
  <li><a href="#gelocation-dataset" id="toc-gelocation-dataset" class="nav-link" data-scroll-target="#gelocation-dataset">Gelocation dataset</a></li>
  <li><a href="#usgs-diagnostics" id="toc-usgs-diagnostics" class="nav-link" data-scroll-target="#usgs-diagnostics">USGS Diagnostics</a></li>
  <li><a href="#examining-excluded-locales" id="toc-examining-excluded-locales" class="nav-link" data-scroll-target="#examining-excluded-locales">Examining excluded locales</a></li>
  </ul>
</li>
  <li>
<a href="#geolocation" id="toc-geolocation" class="nav-link" data-scroll-target="#geolocation">Geolocation</a>
  <ul>
<li>
<a href="#searching-usgs-dataset-geocoding-from-zip" id="toc-searching-usgs-dataset-geocoding-from-zip" class="nav-link" data-scroll-target="#searching-usgs-dataset-geocoding-from-zip">0 &amp; 1: Searching USGS dataset &amp; geocoding from zip</a>
  <ul class="collapse">
<li><a href="#addresses-for-geocoding" id="toc-addresses-for-geocoding" class="nav-link" data-scroll-target="#addresses-for-geocoding">Addresses for geocoding</a></li>
  </ul>
</li>
  <li>
<a href="#geocoding-census-osm-arcgis-geoapify-opencage-mapbox" id="toc-geocoding-census-osm-arcgis-geoapify-opencage-mapbox" class="nav-link" data-scroll-target="#geocoding-census-osm-arcgis-geoapify-opencage-mapbox">2: Geocoding: census &gt; osm &gt; arcgis &gt; geoapify &gt; opencage &gt; mapbox</a>
  <ul class="collapse">
<li><a href="#remaining-addresses" id="toc-remaining-addresses" class="nav-link" data-scroll-target="#remaining-addresses">Remaining Addresses</a></li>
  </ul>
</li>
  </ul>
</li>
  <li><a href="#compiling-final-datasets" id="toc-compiling-final-datasets" class="nav-link" data-scroll-target="#compiling-final-datasets">Compiling final datasets:</a></li>
  <li>
<a href="#other-thoughts" id="toc-other-thoughts" class="nav-link" data-scroll-target="#other-thoughts">Other Thoughts</a>
  <ul>
<li><a href="#alternate-approaches-to-geocoding-reverse-geocoding-nchsurc-classification" id="toc-alternate-approaches-to-geocoding-reverse-geocoding-nchsurc-classification" class="nav-link" data-scroll-target="#alternate-approaches-to-geocoding-reverse-geocoding-nchsurc-classification">Alternate Approaches to Geocoding, Reverse Geocoding &amp; NCHSURC classification</a></li>
  </ul>
</li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session Info</a></li>
  </ul></nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Dataset - Geocoding to County</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Matthew Hoctor, PharmD </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 18, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header><div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## load libraries:</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>      <span class="co"># dplyr, lubridate, stringr, etc, etc, etc</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sfirke/janitor">janitor</a></span><span class="op">)</span>        <span class="co"># adorn_totals()</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.fstpackage.org">fst</a></span><span class="op">)</span>            <span class="co"># read/write .fst files</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>     <span class="co"># ?is this package necessary?</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://readxl.tidyverse.org">readxl</a></span><span class="op">)</span>         <span class="co"># read excel files</span></span>
<span><span class="co"># library(readODS)      # to read .ods file</span></span>
<span><span class="co"># library(campfin)      # for working with abbreviations in US place names</span></span>
<span><span class="co"># library(SUNGEO)       # for batch geocoding from OSM</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://fipio.justinsingh.me">fipio</a></span><span class="op">)</span>          <span class="co"># coords_to_fips()</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/gavinrozzi/zipcodeR/">zipcodeR</a></span><span class="op">)</span>       <span class="co"># for finding zipcode centroid coords</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://jessecambon.github.io/tidygeocoder/">tidygeocoder</a></span><span class="op">)</span>   <span class="co"># for batch geocoding from multiple sources in parallel</span></span>
<span><span class="co"># library(tidycensus)   # ?county name to FIPS?</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/walkerke/tigris">tigris</a></span><span class="op">)</span>         <span class="co"># counties(): download year-specific county data</span></span>
<span></span>
<span><span class="co"># thanks to Josh O'Brien for the following functions:</span></span>
<span><span class="co"># https://stackoverflow.com/questions/26539441/remove-null-elements-from-list-of-lists</span></span>
<span><span class="co">## A helper function that tests whether an object is either NULL _or_ </span></span>
<span><span class="co">## a list of NULLs</span></span>
<span><span class="va">is.NullOb</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">is.null</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## Recursively step down into list, removing all such objects </span></span>
<span><span class="va">rmNullObs</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>   <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Negate</a></span><span class="op">(</span><span class="va">is.NullOb</span><span class="op">)</span>, <span class="va">x</span><span class="op">)</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">x</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="fu">rmNullObs</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="kw">else</span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="overview" class="level1"><h1>Overview</h1>
<p>This project looks to understand the impact of the Comprehensive Addiction and Recovery Act (CARA) of 2016 on patterns of buprenorphine prescribing practices by examining openly available medicare part D data.</p>
<p>The steps in this page require that the data be downloaded first (see the <a href="https://matthew-hoctor.github.io/BupRx/dl.html">data download</a> page), and for the <a href="https://matthew-hoctor.github.io/BupRx/dataset_tx.html">treatment variables</a> to be compiled. The scripts below show the data generation process.</p>
<p>Using the USGS Populated Places dataset, we will attempt to convert the city/state data from the dataset into a a FIPS code, which will be used to lookup the CDC’s 2013 Urban-Rural Classification using the following steps:</p>
<ul>
<li>The USGS dataset (which can be found as a text file within their Geographic Names Information System (GNIS) <a href="https://www.usgs.gov/us-board-on-geographic-names/download-gnis-data">here</a>) contains several variables including the state name/FIPS, the ‘map name’ (which is often the city name), and the county name/FIPS. The first step will be to lookup the city/state in this dataset and retrieve the full FIPS.</li>
<li>Lookup rural-urban clssification: For this step we can use the FIPS code to lookup the CDC’s <a href="https://www.cdc.gov/nchs/data_access/urban_rural.htm">2013 Urban-Rural Classification Scheme for Counties</a>; specifically using the <a href="https://www.cdc.gov/nchs/data/data_acces_files/NCHSURCodes2013.xlsx">NCHSurbruralcodes Spreadsheet</a> which contains the FIPS codes and rural-urban classifications for each county in the US.</li>
</ul>
<p>NB the CDC provides a helpful summary of <a href="https://www.cdc.gov/nchs/nvss/bridged_race/county_geography-_changes1990-present.pdf">County Geography Changes: 1990-present</a>.</p>
</section><section id="datasets" class="level1"><h1>Datasets</h1>
<section id="load-data" class="level2"><h2 class="anchored" data-anchor-id="load-data">Load Data</h2>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load the dataset from the prior step:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"dataset/data_tx.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load the provider data:</span></span>
<span><span class="va">prv</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://www.fstpackage.org/reference/write_fst.html">read_fst</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"dataset/prv.fst"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Download the US counties 2013 dataset from the Census Bureau using the `tigris` package:</span></span>
<span><span class="va">counties_2013</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2013</span>, cb <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>fips <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">STATEFP</span>, <span class="va">COUNTYFP</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">fips</span>, .after <span class="op">=</span> <span class="va">COUNTYFP</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load the USGS Populated Places dataset:</span></span>
<span><span class="va">usgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_delim</a></span><span class="op">(</span></span>
<span>  <span class="st">"data/Text/PopulatedPlaces_National.txt"</span>,</span>
<span>  delim <span class="op">=</span> <span class="st">"|"</span>, <span class="co"># the file is pipe-delimited</span></span>
<span>  col_names <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Prepping a ‘wide’ dataset (the extensive munging is to create a dataset in which each row uniquely maps a state/name pair to a county, see ‘USGS Diagnostics’ section):</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">usgs_wide</span> <span class="op">&lt;-</span> <span class="va">usgs</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state_numeric</span>, <span class="va">county_numeric</span>, <span class="va">map_name</span>, <span class="va">feature_name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># lengthen the dataset by map name and feature name</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">map_name</span>, <span class="va">feature_name</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"type"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"name"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># create new vars to count the 'type' of name in the row</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">type</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># add fips0 variable</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>fips0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">state_numeric</span>, <span class="va">county_numeric</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># tabulate number of FIPS codes for each state/name pair:</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">state_numeric</span>, <span class="va">name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n_fips <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">fips0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># select only rows in which the state/name pair correspond to a single FIPS (i.e. n_fips == 1)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n_fips</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># remove n_fips</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">n_fips</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># retain only unique entries</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># select counties present in 2013 only</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">fips0</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">counties_2013</span><span class="op">$</span><span class="va">fips</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="gelocation-dataset" class="level2"><h2 class="anchored" data-anchor-id="gelocation-dataset">Gelocation dataset</h2>
<p>The following code will create a reduced dataset without entries in the excluded locales described above; NB this step reduces the number of observations in the dataset. A number of typos are corrected and the missing values from the provider dataset are also tabulated:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_fips</span> <span class="op">&lt;-</span> <span class="va">data_tx</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># filter out Puerto Rico, Virgin Islands, and Guam; these are not in NCHSUR  (codes 66, 72, 78):</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Prscrbr_State_FIPS</span> <span class="op">!=</span> <span class="st">"66"</span> <span class="op">&amp;</span> <span class="va">Prscrbr_State_FIPS</span> <span class="op">!=</span> <span class="st">"72"</span> <span class="op">&amp;</span> <span class="va">Prscrbr_State_FIPS</span> <span class="op">!=</span> <span class="st">"78"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># filter out military mail codes (codes AA, AE, AP); other codes (ZZ, XX):</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">Prscrbr_State_Abrvtn</span>, <span class="st">"AA"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">Prscrbr_State_Abrvtn</span>, <span class="st">"AE"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">Prscrbr_State_Abrvtn</span>, <span class="st">"AP"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">Prscrbr_State_Abrvtn</span>, <span class="st">"ZZ"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">Prscrbr_State_Abrvtn</span>, <span class="st">"XX"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># filter out missing state fips:</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Prscrbr_State_FIPS</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># create a new variable to facilitate matching on the City by converting to lower case</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>city_fixed <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op">(</span><span class="va">Prscrbr_City</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>  <span class="co">## join to prv dataset for RUCA, address, ZIP:</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">prv</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">8</span>,<span class="fl">9</span>,<span class="fl">13</span>,<span class="fl">14</span>,<span class="fl">86</span><span class="op">)</span><span class="op">]</span>,                       <span class="co"># y dataset</span></span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span></span>
<span>      <span class="va">Prscrbr_NPI</span> <span class="op">==</span> <span class="va">PRSCRBR_NPI</span>,</span>
<span>      <span class="va">year</span> <span class="op">==</span> <span class="va">year</span><span class="op">)</span>,</span>
<span>    relationship <span class="op">=</span> <span class="st">"many-to-one"</span>                  <span class="co"># left_join will not work without specifying this relation</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># compile address variable</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>address <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">Prscrbr_St1</span>, <span class="st">", "</span>, <span class="va">Prscrbr_City</span>, <span class="st">", "</span>, <span class="va">Prscrbr_State_Abrvtn</span>, <span class="st">" "</span>, <span class="va">Prscrbr_zip5</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>  <span class="co">## Correct typos:</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Prscrbr_State_Abrvtn <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span></span>
<span>    <span class="va">address</span> <span class="op">==</span> <span class="st">"1149 Bloomfield Ave, Clifton, NY 07012"</span>,</span>
<span>    <span class="st">"NJ"</span>,</span>
<span>    <span class="va">Prscrbr_State_Abrvtn</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Prscrbr_State_Abrvtn <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span></span>
<span>    <span class="va">address</span> <span class="op">==</span> <span class="st">"209 Highway 18 South, East Brunswick, PA 08816"</span>,</span>
<span>    <span class="st">"NJ"</span>,</span>
<span>    <span class="va">Prscrbr_State_Abrvtn</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Prscrbr_State_Abrvtn <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span></span>
<span>    <span class="va">address</span> <span class="op">==</span> <span class="st">"1590-01 Constitution Boulvard, Rock Hill, CA 29732"</span>,</span>
<span>    <span class="st">"SC"</span>,</span>
<span>    <span class="va">Prscrbr_State_Abrvtn</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Prscrbr_State_Abrvtn <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span></span>
<span>    <span class="va">address</span> <span class="op">==</span> <span class="st">"209 Nw 8th St, Seminole, NM 79360"</span>,</span>
<span>    <span class="st">"TX"</span>,</span>
<span>    <span class="va">Prscrbr_State_Abrvtn</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Prscrbr_State_Abrvtn <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span></span>
<span>    <span class="va">address</span> <span class="op">==</span> <span class="st">"1149 Bloomfield Ave, Clifton, NY 07012"</span>,</span>
<span>    <span class="st">"NJ"</span>,</span>
<span>    <span class="va">Prscrbr_State_Abrvtn</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Prscrbr_State_Abrvtn <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span></span>
<span>    <span class="va">address</span> <span class="op">==</span> <span class="st">"365 Montauk Ave, New London, TN 06320"</span>,</span>
<span>    <span class="st">"CT"</span>,</span>
<span>    <span class="va">Prscrbr_State_Abrvtn</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Prscrbr_State_Abrvtn <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span></span>
<span>    <span class="va">address</span> <span class="op">==</span> <span class="st">"8687 Connecticut St, Merillville, IL 46410"</span>,</span>
<span>    <span class="st">"IN"</span>,</span>
<span>    <span class="va">Prscrbr_State_Abrvtn</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># exclude the military zip</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Prscrbr_zip5</span> <span class="op">!=</span> <span class="fl">96555</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># correct Lake Mary, FL city and Zip</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Prscrbr_City <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Prscrbr_zip5</span> <span class="op">==</span> <span class="fl">32476</span>, <span class="st">"Lake Mary"</span>, <span class="va">Prscrbr_City</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Prscrbr_zip5 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Prscrbr_zip5</span> <span class="op">==</span> <span class="fl">32476</span>, <span class="fl">32746</span>, <span class="va">Prscrbr_zip5</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># re-compile address variable</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>address <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">Prscrbr_St1</span>, <span class="st">", "</span>, <span class="va">Prscrbr_City</span>, <span class="st">", "</span>, <span class="va">Prscrbr_State_Abrvtn</span>, <span class="st">" "</span>, <span class="va">Prscrbr_zip5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Summary of missing values from provider dataset</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_RUCA</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 345</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_zip5</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_St1</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
</section><section id="usgs-diagnostics" class="level2"><h2 class="anchored" data-anchor-id="usgs-diagnostics">USGS Diagnostics</h2>
<p>It is possible that a single name/state pair could match to multiple different FIPS codes in the unmodified dataset; let’s see if that is the case:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># number of unique state/map_name combinations</span></span>
<span><span class="va">usgs</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># add variables for fips and convert text-formatted date_created variable to a proper date</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>fips <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">state_numeric</span>, <span class="va">county_numeric</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># select counties present in 2013 only</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">fips</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">counties_2013</span><span class="op">$</span><span class="va">fips</span><span class="op">)</span> <span class="op">|&gt;</span>   </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state_numeric</span>, <span class="va">map_name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 36682</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># number of unique fips/map_name combinations</span></span>
<span><span class="va">usgs</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># add variables for fips and convert text-formatted date_created variable to a proper date</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>fips <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">state_numeric</span>, <span class="va">county_numeric</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># select counties present in 2013 only</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">fips</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">counties_2013</span><span class="op">$</span><span class="va">fips</span><span class="op">)</span> <span class="op">|&gt;</span>   </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state_numeric</span>, <span class="va">map_name</span>, <span class="va">county_numeric</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 44585</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># number of unique state/feature_name combinations</span></span>
<span><span class="va">usgs</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># add variables for fips and convert text-formatted date_created variable to a proper date</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>fips <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">state_numeric</span>, <span class="va">county_numeric</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># select counties present in 2013 only</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">fips</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">counties_2013</span><span class="op">$</span><span class="va">fips</span><span class="op">)</span> <span class="op">|&gt;</span>   </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state_numeric</span>, <span class="va">feature_name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 173342</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># number of unique fips/feature_name combinations</span></span>
<span><span class="va">usgs</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># add variables for fips and convert text-formatted date_created variable to a proper date</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>fips <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">state_numeric</span>, <span class="va">county_numeric</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># select counties present in 2013 only</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">fips</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">counties_2013</span><span class="op">$</span><span class="va">fips</span><span class="op">)</span> <span class="op">|&gt;</span>   </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state_numeric</span>, <span class="va">feature_name</span>, <span class="va">county_numeric</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 188596</code></pre>
</div>
</div>
<p>It appears that there are non-unique combinations of state FIPS and map_name, as well as non-unique combinations of state FIPS and feature_name. We don’t want to randomly assign FIPS values to these entries, so we will need to create reduced datasets to match on containing only the unique pairs.</p>
</section><section id="examining-excluded-locales" class="level2"><h2 class="anchored" data-anchor-id="examining-excluded-locales">Examining excluded locales</h2>
<p>Before proceeding, entries from Puerto Rico, Virgin Islands, and Guam and/or any entries with a military mail code, or a missing address will be examined, as they will be filtered out in the next step:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">filtered_geo</span> <span class="op">&lt;-</span> <span class="va">data_tx</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span></span>
<span>    <span class="co"># select Puerto Rico, Virgin Islands, and Guam; these are not in NCHSUR  (codes 66, 72, 78), or NA:</span></span>
<span>    <span class="va">Prscrbr_State_FIPS</span> <span class="op">==</span> <span class="st">"66"</span> <span class="op">|</span> <span class="va">Prscrbr_State_FIPS</span> <span class="op">==</span> <span class="st">"72"</span> <span class="op">|</span> <span class="va">Prscrbr_State_FIPS</span> <span class="op">==</span> <span class="st">"78"</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Prscrbr_State_FIPS</span><span class="op">)</span> <span class="op">|</span></span>
<span>    <span class="co"># select military mail codes (codes AA, AE, AP); other codes (ZZ, XX):</span></span>
<span>    <span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"AA"</span> <span class="op">|</span> <span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"AE"</span> <span class="op">|</span> <span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"AP"</span> <span class="op">|</span> <span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"ZZ"</span> <span class="op">|</span> <span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"XX"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a summary table by Prscrbr_State_Abrvtn of buprenorphine prescribers:</span></span>
<span><span class="va">filtered_geo</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">MAT_generic</span> <span class="op">==</span> <span class="st">"bup"</span> <span class="op">|</span> <span class="va">MAT_brand</span> <span class="op">==</span> <span class="st">"bup"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Prscrbr_State_Abrvtn</span>, <span class="va">tx</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>N_prescribers <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>, patient_years_supplied <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">Tot_Day_Suply</span><span class="op">/</span><span class="fl">365</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">patient_years_supplied</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://sfirke.github.io/janitor/reference/adorn_totals.html">adorn_totals</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Prscrbr_State_Abrvtn'. You can override
using the `.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Prscrbr_State_Abrvtn       tx N_prescribers patient_years_supplied
                   PR  bup_oud           421             681.049315
                   PR bup_pain           128             255.550685
                   AA  bup_oud             3              11.263014
                   VI  bup_oud             5               5.194521
                   XX  bup_oud             3               4.079452
                   XX bup_pain             2               3.630137
                   ZZ  bup_oud             4               3.526027
                Total        -           566             964.293151</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create a summary table by Prscrbr_State_Abrvtn of buprenorphine prescribers:</span></span>
<span><span class="va">filtered_geo</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">MAT_generic</span> <span class="op">==</span> <span class="st">"met"</span> <span class="op">|</span> <span class="va">MAT_brand</span> <span class="op">==</span> <span class="st">"met"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Prscrbr_State_Abrvtn</span>, <span class="va">tx</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>N_prescribers <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>, patient_years_supplied <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">Tot_Day_Suply</span><span class="op">/</span><span class="fl">365</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">patient_years_supplied</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://sfirke.github.io/janitor/reference/adorn_totals.html">adorn_totals</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Prscrbr_State_Abrvtn'. You can override
using the `.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Prscrbr_State_Abrvtn      tx N_prescribers patient_years_supplied
                   PR met_oud            33              41.386301
                   ZZ met_oud             5              11.780822
                   XX met_oud             5              11.706849
                   GU met_oud             7              10.649315
                   VI met_oud             4               6.227397
                   AE met_oud             4               3.309589
                Total       -            58              85.060274</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create a summary table by Prscrbr_State_Abrvtn of buprenorphine prescribers:</span></span>
<span><span class="va">filtered_geo</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">MAT_generic</span> <span class="op">==</span> <span class="st">"nal"</span> <span class="op">|</span> <span class="va">MAT_brand</span> <span class="op">==</span> <span class="st">"nal"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Prscrbr_State_Abrvtn</span>, <span class="va">tx</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>N_prescribers <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>, patient_years_supplied <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">Tot_Day_Suply</span><span class="op">/</span><span class="fl">365</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">patient_years_supplied</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://sfirke.github.io/janitor/reference/adorn_totals.html">adorn_totals</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Prscrbr_State_Abrvtn'. You can override
using the `.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Prscrbr_State_Abrvtn      tx N_prescribers patient_years_supplied
                   PR nal_oud            57             156.605479
                   GU nal_oud             2               2.712329
                   ZZ nal_oud             2               1.884932
                Total       -            61             161.202740</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Some cleanup:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">filtered_geo</span>, <span class="va">counties_2013</span>, <span class="va">data_tx</span>, <span class="va">prv</span>, <span class="va">usgs</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="geolocation" class="level1"><h1>Geolocation</h1>
<section id="searching-usgs-dataset-geocoding-from-zip" class="level2"><h2 class="anchored" data-anchor-id="searching-usgs-dataset-geocoding-from-zip">0 &amp; 1: Searching USGS dataset &amp; geocoding from zip</h2>
<p>We can now search the USGS dataset for the FIPS code corresponding to the city/state pair in the CDC dataset:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># search USGS:</span></span>
<span><span class="va">data_fips</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_fips</span>,                      <span class="co"># x dataset</span></span>
<span>  <span class="va">usgs_wide</span>,                                           <span class="co"># y dataset</span></span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span></span>
<span>    <span class="va">Prscrbr_State_FIPS</span> <span class="op">==</span> <span class="va">state_numeric</span>,</span>
<span>    <span class="va">city_fixed</span> <span class="op">==</span> <span class="va">name</span><span class="op">)</span>,</span>
<span>  relationship <span class="op">=</span> <span class="st">"many-to-one"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># geocode from zipcode centroid &amp; reverse to fips:</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_zip5</span> <span class="op">|&gt;</span>                          <span class="co"># y dataset</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>                                      <span class="co"># y dataset</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/zipcodeR/man/geocode_zip.html">geocode_zip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>                                 <span class="co"># y dataset</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>fips1 <span class="op">=</span> <span class="fu"><a href="https://fipio.justinsingh.me/reference/coords_to_fips.html">coords_to_fips</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">lng</span>, y <span class="op">=</span> <span class="va">lat</span><span class="op">)</span><span class="op">)</span>,<span class="co"># y dataset</span></span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">Prscrbr_zip5</span> <span class="op">==</span> <span class="va">zipcode</span><span class="op">)</span>,</span>
<span>    relationship <span class="op">=</span> <span class="st">"many-to-one"</span><span class="op">)</span> <span class="op">|&gt;</span>          </span>
<span>  <span class="co">## add variables for diagnosis</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># get the state abbreviation</span></span>
<span>    State_Abbrevtn <span class="op">=</span> <span class="fu"><a href="https://fipio.justinsingh.me/reference/fips_abbr.html">fips_abbr</a></span><span class="op">(</span><span class="va">fips1</span><span class="op">)</span>,</span>
<span>    <span class="co"># check if the state is correct</span></span>
<span>    miss_state1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="va">State_Abbrevtn</span>,</span>
<span>                         <span class="fl">0</span>, <span class="fl">1</span>, missing <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>    <span class="co"># document the query</span></span>
<span>    query0 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">fips0</span><span class="op">)</span>,</span>
<span>                    <span class="st">"USGS"</span>,</span>
<span>                    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">fips1</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">miss_state1</span> <span class="op">==</span> <span class="fl">0</span>,</span>
<span>                            <span class="st">"zip"</span>,</span>
<span>                            <span class="st">"geo"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    fips <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">fips0</span><span class="op">)</span>,</span>
<span>                    <span class="va">fips0</span>,</span>
<span>                    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">fips1</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">miss_state1</span> <span class="op">==</span> <span class="fl">0</span>,</span>
<span>                            <span class="va">fips1</span>,</span>
<span>                            <span class="cn">NA</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">lat</span>, <span class="op">-</span><span class="va">lng</span>, <span class="op">-</span><span class="va">State_Abbrevtn</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># diagnostics:</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">query0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    Missing_fips <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">fips</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Miss_USGS <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">fips0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Miss_ZIP <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">miss_state1</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>    N_city_state_combo <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span><span class="op">(</span><span class="va">Prscrbr_City</span>, <span class="va">Prscrbr_State_FIPS</span><span class="op">)</span>,</span>
<span>    N_addresses <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span><span class="op">(</span><span class="va">address</span><span class="op">)</span>,</span>
<span>    N <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://sfirke.github.io/janitor/reference/adorn_totals.html">adorn_totals</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code> query0 Missing_fips Miss_USGS Miss_ZIP N_city_state_combo N_addresses      N
    geo         9665      9665     9665                298        1297   9665
    zip            0     94540        0               2454       13589  94540
   USGS            0         0    52494               7159       54707 401190
  Total         9665    104205    62159               9911       69593 505395</code></pre>
</div>
</div>
<p>It appears that ~70% of city/state combos were resolved with the USGS dataset. Furthermore the bulk of the unresolved entries seem to have city/state pairs in highly populated areas, where place names likely do not uniquely resolve to counties. Thus we can find more information on these providers in the <a href="https://data.cms.gov/provider-summary-by-type-of-service/medicare-part-d-prescribers/medicare-part-d-prescribers-by-provider">Medicare Part D Prescribers - by Provider</a> dataset, and then lookup their fips via geolocation.</p>
<section id="addresses-for-geocoding" class="level3"><h3 class="anchored" data-anchor-id="addresses-for-geocoding">Addresses for geocoding</h3>
<p>We will now create a dataset containing the address to geocode; these will include all addresses not resolved with the USGS dataset, and a random sampling of those successfully resolved:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># set seed for slice_sample function</span></span>
<span><span class="va">seed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span></span>
<span><span class="va">seed</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 1716078674</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create list of addresses</span></span>
<span><span class="va">addresses</span> <span class="op">&lt;-</span> <span class="va">data_fips</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># selecting unmatched entries</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">query0</span> <span class="op">==</span> <span class="st">"geo"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">address</span>, <span class="va">Prscrbr_St1</span>, <span class="va">Prscrbr_City</span>, <span class="va">Prscrbr_State_Abrvtn</span>, <span class="va">Prscrbr_zip5</span>, <span class="va">miss_state1</span>, <span class="va">query0</span>, <span class="va">fips</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>group <span class="op">=</span> <span class="st">"geocode"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co">## binding to randomly chosen entries</span></span>
<span>  <span class="co"># entries which matched to USGS and ZIP</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span></span>
<span>    <span class="va">data_fips</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">query0</span> <span class="op">==</span> <span class="st">"USGS"</span> <span class="op">&amp;</span> <span class="va">miss_state1</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">address</span>, <span class="va">Prscrbr_St1</span>, <span class="va">Prscrbr_City</span>, <span class="va">Prscrbr_State_Abrvtn</span>, <span class="va">Prscrbr_zip5</span>, <span class="va">miss_state1</span>, <span class="va">query0</span>, <span class="va">fips</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>group <span class="op">=</span> <span class="st">"USGS &amp; Zip"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># entries which matched to USGS but not ZIP</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span></span>
<span>    <span class="va">data_fips</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">query0</span> <span class="op">==</span> <span class="st">"USGS"</span> <span class="op">&amp;</span> <span class="va">miss_state1</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">address</span>, <span class="va">Prscrbr_St1</span>, <span class="va">Prscrbr_City</span>, <span class="va">Prscrbr_State_Abrvtn</span>, <span class="va">Prscrbr_zip5</span>, <span class="va">miss_state1</span>, <span class="va">query0</span>, <span class="va">fips</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>group <span class="op">=</span> <span class="st">"USGS"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># entries which matched to ZIP but not USGS</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span></span>
<span>    <span class="va">data_fips</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">query0</span> <span class="op">==</span> <span class="st">"zip"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">address</span>, <span class="va">Prscrbr_St1</span>, <span class="va">Prscrbr_City</span>, <span class="va">Prscrbr_State_Abrvtn</span>, <span class="va">Prscrbr_zip5</span>, <span class="va">miss_state1</span>, <span class="va">query0</span>, <span class="va">fips</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>group <span class="op">=</span> <span class="st">"Zip"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="geocoding-census-osm-arcgis-geoapify-opencage-mapbox" class="level2"><h2 class="anchored" data-anchor-id="geocoding-census-osm-arcgis-geoapify-opencage-mapbox">2: Geocoding: census &gt; osm &gt; arcgis &gt; geoapify &gt; opencage &gt; mapbox</h2>
<p>Define queries:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">queries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  service <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"census"</span></span>
<span>    , <span class="st">"arcgis"</span>      <span class="co"># limit 1?</span></span>
<span>    , <span class="st">"osm"</span>         <span class="co"># limit 1/s</span></span>
<span>    , <span class="st">"iq"</span>          <span class="co"># limit 1/s;    5000/d</span></span>
<span>    , <span class="st">"tomtom"</span>      <span class="co"># limit 5/s;    2500/d</span></span>
<span>    <span class="co"># , "mapbox"      # limit 10/s;   100000 free requests</span></span>
<span>    , <span class="st">"geoapify"</span>    <span class="co"># limit 5/s;    3000/d</span></span>
<span>    <span class="co"># , "opencage"  # limit reached, limit 1/s; 2500/d</span></span>
<span>    , <span class="st">"geocodio"</span>    <span class="co"># limit 16.7/s; 2500/d</span></span>
<span>    <span class="co"># , "here"        # limit 5/s;    1000/d</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">queries</span> <span class="op">&lt;-</span> <span class="va">queries</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">queries</span><span class="op">)</span>,</span>
<span>    queries <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'census'</span>,</span>
<span>           street <span class="op">=</span> <span class="st">'Prscrbr_St1'</span>,</span>
<span>           city <span class="op">=</span> <span class="st">'Prscrbr_City'</span>,</span>
<span>           state <span class="op">=</span> <span class="st">'Prscrbr_State_Abrvtn'</span>,</span>
<span>           postalcode <span class="op">=</span> <span class="st">'Prscrbr_zip5'</span><span class="op">)</span></span>
<span>      , <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'arcgis'</span></span>
<span>           , address <span class="op">=</span> <span class="st">'address'</span><span class="op">)</span></span>
<span>      , <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'osm'</span>,</span>
<span>           street <span class="op">=</span> <span class="st">'Prscrbr_St1'</span>,</span>
<span>           city <span class="op">=</span> <span class="st">'Prscrbr_City'</span>,</span>
<span>           state <span class="op">=</span> <span class="st">'Prscrbr_State_Abrvtn'</span>,</span>
<span>           postalcode <span class="op">=</span> <span class="st">'Prscrbr_zip5'</span><span class="op">)</span></span>
<span>      , <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'iq'</span></span>
<span>           , street <span class="op">=</span> <span class="st">'Prscrbr_St1'</span></span>
<span>           , city <span class="op">=</span> <span class="st">'Prscrbr_City'</span></span>
<span>           , state <span class="op">=</span> <span class="st">'Prscrbr_State_Abrvtn'</span></span>
<span>           , postalcode <span class="op">=</span> <span class="st">'Prscrbr_zip5'</span></span>
<span>           , custom_query <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>           <span class="op">)</span></span>
<span>      , <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'tomtom'</span></span>
<span>           , address <span class="op">=</span> <span class="st">'address'</span></span>
<span>           , custom_query <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>           <span class="op">)</span></span>
<span>      <span class="co"># , list(method = 'mapbox'</span></span>
<span>      <span class="co">#      , address = 'address'</span></span>
<span>      <span class="co">#      , custom_query = list(limit = 10)</span></span>
<span>      <span class="co">#      )</span></span>
<span>      , <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'geoapify'</span></span>
<span>           , street <span class="op">=</span> <span class="st">'Prscrbr_St1'</span></span>
<span>           , city <span class="op">=</span> <span class="st">'Prscrbr_City'</span></span>
<span>           , state <span class="op">=</span> <span class="st">'Prscrbr_State_Abrvtn'</span></span>
<span>           , postalcode <span class="op">=</span> <span class="st">'Prscrbr_zip5'</span></span>
<span>           , custom_query <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>           <span class="op">)</span></span>
<span>      <span class="co"># , list(method = 'opencage'</span></span>
<span>      <span class="co">#      , address = 'address'</span></span>
<span>      <span class="co">#      , custom_query = list(limit = 1)</span></span>
<span>      <span class="co">#      )</span></span>
<span>      , <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'geocodio'</span></span>
<span>           , street <span class="op">=</span> <span class="st">'Prscrbr_St1'</span></span>
<span>           , city <span class="op">=</span> <span class="st">'Prscrbr_City'</span></span>
<span>           , state <span class="op">=</span> <span class="st">'Prscrbr_State_Abrvtn'</span></span>
<span>           , postalcode <span class="op">=</span> <span class="st">'Prscrbr_zip5'</span></span>
<span>           , custom_query <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>           <span class="op">)</span></span>
<span>      <span class="co"># , list(method = 'here'</span></span>
<span>      <span class="co">#      , address = 'address'</span></span>
<span>      <span class="co">#      , custom_query = list(limit = 5)</span></span>
<span>      <span class="co">#      )</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="va">queries</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>   service i
1   census 1
2   arcgis 2
3      osm 3
4       iq 4
5   tomtom 5
6 geoapify 6
7 geocodio 7
                                                                     queries
1      census, Prscrbr_St1, Prscrbr_City, Prscrbr_State_Abrvtn, Prscrbr_zip5
2                                                            arcgis, address
3         osm, Prscrbr_St1, Prscrbr_City, Prscrbr_State_Abrvtn, Prscrbr_zip5
4       iq, Prscrbr_St1, Prscrbr_City, Prscrbr_State_Abrvtn, Prscrbr_zip5, 1
5                                                         tomtom, address, 5
6 geoapify, Prscrbr_St1, Prscrbr_City, Prscrbr_State_Abrvtn, Prscrbr_zip5, 5
7 geocodio, Prscrbr_St1, Prscrbr_City, Prscrbr_State_Abrvtn, Prscrbr_zip5, 5</code></pre>
</div>
</div>
<p>The following code geocodes entries individually so as not to exceed limits for each service. NB geocoding API keys be generated and stored as an environmental variable (i.e.&nbsp;edit .Renviron, and load) for services other than US Census, OSM &amp; ArcGIS.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">addresses_geo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">top_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">addresses</span><span class="op">)</span></span>
<span><span class="va">top_j</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">queries</span><span class="op">)</span></span>
<span><span class="co"># top_i &lt;- 100</span></span>
<span><span class="co"># top_j &lt;- 3</span></span>
<span>  </span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">top_i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">addresses2</span> <span class="op">&lt;-</span> <span class="va">addresses</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>fips_geo <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">top_j</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">service</span> <span class="op">&lt;-</span> <span class="va">queries</span><span class="op">[</span><span class="va">j</span>,<span class="op">]</span><span class="op">$</span><span class="va">service</span></span>
<span>    <span class="va">addresses2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://jessecambon.github.io/tidygeocoder/reference/geocode.html">geocode</a></span><span class="op">(</span></span>
<span>      <span class="va">addresses2</span>,</span>
<span>      address <span class="op">=</span> <span class="va">address</span>,</span>
<span>      method <span class="op">=</span> <span class="va">service</span>,</span>
<span>      quiet <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      fips2 <span class="op">=</span> <span class="fu"><a href="https://fipio.justinsingh.me/reference/coords_to_fips.html">coords_to_fips</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">long</span>, y <span class="op">=</span> <span class="va">lat</span><span class="op">)</span>,</span>
<span>      miss_state2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span></span>
<span>        <span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="fu"><a href="https://fipio.justinsingh.me/reference/fips_abbr.html">fips_abbr</a></span><span class="op">(</span><span class="va">fips2</span><span class="op">)</span>,</span>
<span>        <span class="fl">0</span>, <span class="fl">1</span>, missing <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>      fips_geo <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span></span>
<span>        <span class="va">miss_state2</span> <span class="op">==</span> <span class="fl">0</span>,</span>
<span>        <span class="va">fips2</span>, <span class="va">fips_geo</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">addresses2</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">addresses2</span><span class="op">)</span> <span class="op">==</span> <span class="st">"lat"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"lat_"</span>, <span class="va">service</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">addresses2</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">addresses2</span><span class="op">)</span> <span class="op">==</span> <span class="st">"long"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"long_"</span>, <span class="va">service</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">addresses2</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">addresses2</span><span class="op">)</span> <span class="op">==</span> <span class="st">"fips2"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"fips_"</span>, <span class="va">service</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">addresses2</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">addresses2</span><span class="op">)</span> <span class="op">==</span> <span class="st">"miss_state2"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"miss_state_"</span>, <span class="va">service</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">addresses_geo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span></span>
<span>    <span class="va">addresses_geo</span>,</span>
<span>    <span class="va">addresses2</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Unable to geocode</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Unable to geocode</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Unable to geocode</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Unable to geocode</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Unable to geocode</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Unable to geocode</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Unable to geocode</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Unable to geocode</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Unable to geocode</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Unable to geocode</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in query_api(api_url, api_query_parameters, method = method): Not Found
(HTTP 404).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Error: Not Found</code></pre>
</div>
</div>
<p>Diagnostics:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb122"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">addresses_geo</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">group</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    Missing_fips <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">fips_geo</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    N <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://sfirke.github.io/janitor/reference/adorn_totals.html">adorn_totals</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>      group Missing_fips    N
    geocode           69 1297
       USGS            1  100
 USGS &amp; Zip            1  100
        Zip            0  100
      Total           71 1597</code></pre>
</div>
</div>
<p>We can see that about half of the addresses have been successfully resolved.</p>
<section id="remaining-addresses" class="level3"><h3 class="anchored" data-anchor-id="remaining-addresses">Remaining Addresses</h3>
<p>Examine the addresses which were not matched by USGS, zipcode, or geocoding:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb124"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">addresses_geo</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">query0</span> <span class="op">==</span> <span class="st">"geo"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">fips_geo</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">address</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 69 × 1
   address                                     
   &lt;chr&gt;                                       
 1 221 E Hampden Ave, Englewood, CO 80113      
 2 499 E Hampden Ave, Englewood, CO 80113      
 3 5257 S Wadsworth Blvd, Littleton, CO 80123  
 4 601 E Hampden Ave, Englewood, CO 80113      
 5 13199 Centerpointe Way, Woodbridge, VA 22193
 6 6169 S Balsam Way, Littleton, CO 80123      
 7 112 Champagne Blvd, Breaux Bridge, LA 70517 
 8 799 E Hampden Avenue, Englewood, CO 80113   
 9 799 E Hampden Ave, Englewood, CO 80113      
10 1555 Gary Dr Ste C, Breaux Bridge, LA 70517 
# ℹ 59 more rows</code></pre>
</div>
</div>
</section></section></section><section id="compiling-final-datasets" class="level1"><h1>Compiling final datasets:</h1>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb126"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_fips</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_fips</span>,               <span class="co"># L dataset</span></span>
<span>  <span class="va">addresses_geo</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">address</span>, <span class="va">fips_geo</span><span class="op">)</span>,   <span class="co"># R dataset</span></span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">address</span> <span class="op">==</span> <span class="va">address</span><span class="op">)</span>,</span>
<span>  relationship <span class="op">=</span> <span class="st">"many-to-one"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># fold geocoded fips codes into main fips var</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>fips <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span></span>
<span>    <span class="va">query0</span> <span class="op">==</span> <span class="st">"geo"</span>,</span>
<span>    <span class="va">fips_geo</span>, </span>
<span>    <span class="va">fips</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Save datasets:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb127"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">data_fips</span>,</span>
<span>     file <span class="op">=</span> <span class="st">"dataset/data_fips.RData"</span>,</span>
<span>     compress <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>     compression_level <span class="op">=</span> <span class="fl">9</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">addresses_geo</span>,</span>
<span>     file <span class="op">=</span> <span class="st">"dataset/addresses_geo.RData"</span>,</span>
<span>     compress <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>     compression_level <span class="op">=</span> <span class="fl">9</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="other-thoughts" class="level1"><h1>Other Thoughts</h1>
<p>Indication for OUD use (vs pain or EtOH use disorder) is a potential source of error when classifying prescriptions in the <code>tx</code> variable. Consider future methods to potentially validate OUD vs pain treatment designations (as time allows):</p>
<ul>
<li>Classify prescriptions as OUD vs pain vs EtOH use disorder based on KNN of names of other drugs prescribed by the provider</li>
<li>Query <a href="https://open.fda.gov/apis/drug/ndc/how-to-use-the-endpoint/">FDA NDC DB</a> for NPIs associated with the values of <code>Brnd_Name</code> and <code>Gnrc_Name</code> which were matched above, then search those NDCs for the indication for use on DailyMed</li>
<li>Check DEA X waver for prescriber’s NPI</li>
<li>Check prescriber’s buprenorphine panel limit vs count of buprenorphine prescribed</li>
<li>Check prescriber’s place of work in NPI DB</li>
<li>interrogate/validate CMS’s method for translating a drug’s NDC into a drug’s brand and generic names</li>
<li>recalculate the rural-urban classification for each year using the <a href="https://www.census.gov/programs-surveys/popest/data/data-sets.html">census estimates</a>
</li>
</ul>
<p>Translation from NDC to a drug’s brand/generic names likely simplifies many analyses, but could be a significant source of bias for our analysis.</p>
<section id="alternate-approaches-to-geocoding-reverse-geocoding-nchsurc-classification" class="level2"><h2 class="anchored" data-anchor-id="alternate-approaches-to-geocoding-reverse-geocoding-nchsurc-classification">Alternate Approaches to Geocoding, Reverse Geocoding &amp; NCHSURC classification</h2>
<p>Alternate geocoding:</p>
<ul>
<li>The <code><a href="https://jessecambon.github.io/tidygeocoder/reference/geocode.html">geocode()</a></code> function from the <code>ggmap</code> package to find the coordinates for each city/state combination. The function will return a dataframe with the coordinates for each city/state combination, and will also return a status code indicating whether the coordinates were found successfully. We will use the status code to filter out any entries for which the coordinates were not found. This method requires access to the google API.</li>
</ul>
<p>Alternate reverse-geocoding:</p>
<ul>
<li>The <code>fips()</code> function from the <code>USAboundaries</code> package to convert the coordinates to FIPS code. This function uses the <code>sf</code> package to find the FIPS code for the county in which the coordinates are located. This method is the most straightforward, but it is also the slowest.</li>
<li>The <code>fips()</code> function from the <code>tigris</code> package to convert the coordinates to FIPS code. This function uses the <code>sf</code> package to find the FIPS code for the county in which the coordinates are located. This method is faster than the <code>USAboundaries</code> method, but it is still relatively slow.</li>
<li>The <code>fips()</code> function from the <code>MazamaSpatialUtils</code> package to convert the coordinates to FIPS code. This function uses a lookup table to find the FIPS code for the county in which the coordinates are located. This method is the fastest, but it is also the least accurate. The lookup table is based on the 2010 census, so it will not include any counties that were created after 2010. This method will also not work for any coordinates that are outside of the US.</li>
</ul>
<p>Rural-urban classification:</p>
<ul>
<li>Lookup rural-urban clssification: For this step we can used CDC’s <a href="https://www.cdc.gov/nchs/data_access/urban_rural.htm">2013 Urban-Rural Classification Scheme for Counties</a>; specifically the <a href="https://www.cdc.gov/nchs/data/data_acces_files/NCHSURCodes2013.xlsx">NCHSurbruralcodes Spreadsheet</a> which contains the FIPS codes and rural-urban classifications for each county in the US. The data can be plotted according to FIPS code using <code>ggplot2</code> or <code>MazamaSpatialPlots</code> packages.</li>
<li>Alternatively the classification could be manually recalculated from census data for each year.</li>
</ul></section></section><section id="session-info" class="level1"><h1>Session Info</h1>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb128"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>R version 4.4.0 (2024-04-24)
Platform: x86_64-pc-linux-gnu
Running under: Ubuntu 22.04.4 LTS

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.10.0 
LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.10.0

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

time zone: America/Vancouver
tzcode source: system (glibc)

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] fstcore_0.9.18     tigris_2.1         tidygeocoder_1.0.5 zipcodeR_0.3.5    
 [5] fipio_1.1.2        readxl_1.4.3       data.table_1.15.0  fst_0.9.8         
 [9] janitor_2.2.0      lubridate_1.9.3    forcats_1.0.0      stringr_1.5.1     
[13] dplyr_1.1.4        purrr_1.0.2        readr_2.1.5        tidyr_1.3.1       
[17] tibble_3.2.1       ggplot2_3.4.4      tidyverse_2.0.0   

loaded via a namespace (and not attached):
 [1] gtable_0.3.4       raster_3.6-26      xfun_0.43          htmlwidgets_1.6.4 
 [5] lattice_0.22-5     tzdb_0.4.0         vctrs_0.6.5        tools_4.4.0       
 [9] generics_0.1.3     curl_5.2.1         parallel_4.4.0     RSQLite_2.3.6     
[13] proxy_0.4-27       fansi_1.0.6        blob_1.2.4         pkgconfig_2.0.3   
[17] KernSmooth_2.23-22 uuid_1.2-0         lifecycle_1.0.4    compiler_4.4.0    
[21] munsell_0.5.0      terra_1.7-71       codetools_0.2-19   snakecase_0.11.1  
[25] htmltools_0.5.8.1  class_7.3-22       yaml_2.3.8         crayon_1.5.2      
[29] pillar_1.9.0       classInt_0.4-10    cachem_1.0.8       tidyselect_1.2.1  
[33] rvest_1.0.4        digest_0.6.34      stringi_1.8.3      sf_1.0-16         
[37] fastmap_1.1.1      grid_4.4.0         colorspace_2.1-0   cli_3.6.2         
[41] magrittr_2.0.3     utf8_1.2.4         e1071_1.7-14       withr_3.0.0       
[45] scales_1.3.0       rappdirs_0.3.3     sp_2.1-4           bit64_4.0.5       
[49] timechange_0.3.0   rmarkdown_2.26     httr_1.4.7         bit_4.0.5         
[53] cellranger_1.1.0   hms_1.1.3          memoise_2.0.1      evaluate_0.23     
[57] knitr_1.46         rlang_1.1.3        Rcpp_1.0.12        glue_1.7.0        
[61] DBI_1.2.2          xml2_1.3.6         vroom_1.6.5        rstudioapi_0.15.0 
[65] jsonlite_1.8.8     R6_2.5.1           tidycensus_1.6.3   units_0.8-5       </code></pre>
</div>
</div>
<!-- -->

</section></main><!-- /main column --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb130" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Dataset - Geocoding to County"</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Matthew Hoctor, PharmD"</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> last-modified</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a><span class="co">quarto::html_document:</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="co">  theme: cerulean</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a><span class="co">  highlight: github</span></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a><span class="an">toc:</span><span class="co"> true</span></span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a><span class="an">toc-depth:</span><span class="co"> 4</span></span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a><span class="an">toc-location:</span><span class="co"> left</span></span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a><span class="an">toc-title:</span><span class="co"> Contents</span></span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a><span class="an">code-fold:</span><span class="co"> show</span></span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a><span class="an">code-overflow:</span><span class="co"> wrap</span></span>
<span id="cb130-17"><a href="#cb130-17" aria-hidden="true" tabindex="-1"></a><span class="an">code-tools:</span><span class="co"> true</span></span>
<span id="cb130-18"><a href="#cb130-18" aria-hidden="true" tabindex="-1"></a><span class="an">code-link:</span><span class="co"> true</span></span>
<span id="cb130-19"><a href="#cb130-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-20"><a href="#cb130-20" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> source</span></span>
<span id="cb130-21"><a href="#cb130-21" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb130-22"><a href="#cb130-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-25"><a href="#cb130-25" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-26"><a href="#cb130-26" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb130-27"><a href="#cb130-27" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb130-28"><a href="#cb130-28" aria-hidden="true" tabindex="-1"></a><span class="do">## load libraries:</span></span>
<span id="cb130-29"><a href="#cb130-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)      <span class="co"># dplyr, lubridate, stringr, etc, etc, etc</span></span>
<span id="cb130-30"><a href="#cb130-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)        <span class="co"># adorn_totals()</span></span>
<span id="cb130-31"><a href="#cb130-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fst)            <span class="co"># read/write .fst files</span></span>
<span id="cb130-32"><a href="#cb130-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)     <span class="co"># ?is this package necessary?</span></span>
<span id="cb130-33"><a href="#cb130-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)         <span class="co"># read excel files</span></span>
<span id="cb130-34"><a href="#cb130-34" aria-hidden="true" tabindex="-1"></a><span class="co"># library(readODS)      # to read .ods file</span></span>
<span id="cb130-35"><a href="#cb130-35" aria-hidden="true" tabindex="-1"></a><span class="co"># library(campfin)      # for working with abbreviations in US place names</span></span>
<span id="cb130-36"><a href="#cb130-36" aria-hidden="true" tabindex="-1"></a><span class="co"># library(SUNGEO)       # for batch geocoding from OSM</span></span>
<span id="cb130-37"><a href="#cb130-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fipio)          <span class="co"># coords_to_fips()</span></span>
<span id="cb130-38"><a href="#cb130-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(zipcodeR)       <span class="co"># for finding zipcode centroid coords</span></span>
<span id="cb130-39"><a href="#cb130-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidygeocoder)   <span class="co"># for batch geocoding from multiple sources in parallel</span></span>
<span id="cb130-40"><a href="#cb130-40" aria-hidden="true" tabindex="-1"></a><span class="co"># library(tidycensus)   # ?county name to FIPS?</span></span>
<span id="cb130-41"><a href="#cb130-41" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tigris)         <span class="co"># counties(): download year-specific county data</span></span>
<span id="cb130-42"><a href="#cb130-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-43"><a href="#cb130-43" aria-hidden="true" tabindex="-1"></a><span class="co"># thanks to Josh O'Brien for the following functions:</span></span>
<span id="cb130-44"><a href="#cb130-44" aria-hidden="true" tabindex="-1"></a><span class="co"># https://stackoverflow.com/questions/26539441/remove-null-elements-from-list-of-lists</span></span>
<span id="cb130-45"><a href="#cb130-45" aria-hidden="true" tabindex="-1"></a><span class="do">## A helper function that tests whether an object is either NULL _or_ </span></span>
<span id="cb130-46"><a href="#cb130-46" aria-hidden="true" tabindex="-1"></a><span class="do">## a list of NULLs</span></span>
<span id="cb130-47"><a href="#cb130-47" aria-hidden="true" tabindex="-1"></a>is.NullOb <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">is.null</span>(x) <span class="sc">|</span> <span class="fu">all</span>(<span class="fu">sapply</span>(x, is.null))</span>
<span id="cb130-48"><a href="#cb130-48" aria-hidden="true" tabindex="-1"></a><span class="do">## Recursively step down into list, removing all such objects </span></span>
<span id="cb130-49"><a href="#cb130-49" aria-hidden="true" tabindex="-1"></a>rmNullObs <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb130-50"><a href="#cb130-50" aria-hidden="true" tabindex="-1"></a>   x <span class="ot">&lt;-</span> <span class="fu">Filter</span>(<span class="fu">Negate</span>(is.NullOb), x)</span>
<span id="cb130-51"><a href="#cb130-51" aria-hidden="true" tabindex="-1"></a>   <span class="fu">lapply</span>(x, <span class="cf">function</span>(x) <span class="cf">if</span> (<span class="fu">is.list</span>(x)) <span class="fu">rmNullObs</span>(x) <span class="cf">else</span> x)</span>
<span id="cb130-52"><a href="#cb130-52" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb130-53"><a href="#cb130-53" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-54"><a href="#cb130-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-55"><a href="#cb130-55" aria-hidden="true" tabindex="-1"></a><span class="fu"># Overview</span></span>
<span id="cb130-56"><a href="#cb130-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-57"><a href="#cb130-57" aria-hidden="true" tabindex="-1"></a>This project looks to understand the impact of the Comprehensive Addiction and Recovery Act (CARA) of 2016 on patterns of buprenorphine prescribing practices by examining openly available medicare part D data.</span>
<span id="cb130-58"><a href="#cb130-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-59"><a href="#cb130-59" aria-hidden="true" tabindex="-1"></a>The steps in this page require that the data be downloaded first (see the <span class="co">[</span><span class="ot">data download</span><span class="co">](https://matthew-hoctor.github.io/BupRx/dl.html)</span> page), and for the <span class="co">[</span><span class="ot">treatment variables</span><span class="co">](https://matthew-hoctor.github.io/BupRx/dataset_tx.html)</span> to be compiled.  The scripts below show the data generation process.</span>
<span id="cb130-60"><a href="#cb130-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-61"><a href="#cb130-61" aria-hidden="true" tabindex="-1"></a>Using the USGS Populated Places dataset, we will attempt to convert the city/state data from the dataset into a a FIPS code, which will be used to lookup the CDC's 2013 Urban-Rural Classification using the following steps:</span>
<span id="cb130-62"><a href="#cb130-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-63"><a href="#cb130-63" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>The USGS dataset (which can be found as a text file within their Geographic Names Information System (GNIS) <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.usgs.gov/us-board-on-geographic-names/download-gnis-data)</span>) contains several variables including the state name/FIPS, the 'map name' (which is often the city name), and the county name/FIPS.  The first step will be to lookup the city/state in this dataset and retrieve the full FIPS.</span>
<span id="cb130-64"><a href="#cb130-64" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Lookup rural-urban clssification: For this step we can use the FIPS code to lookup the CDC's <span class="co">[</span><span class="ot">2013 Urban-Rural Classification Scheme for Counties</span><span class="co">](https://www.cdc.gov/nchs/data_access/urban_rural.htm)</span>; specifically using the <span class="co">[</span><span class="ot">NCHSurbruralcodes Spreadsheet</span><span class="co">](https://www.cdc.gov/nchs/data/data_acces_files/NCHSURCodes2013.xlsx)</span> which contains the FIPS codes and rural-urban classifications for each county in the US.</span>
<span id="cb130-65"><a href="#cb130-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-66"><a href="#cb130-66" aria-hidden="true" tabindex="-1"></a>NB the CDC provides a helpful summary of <span class="co">[</span><span class="ot">County Geography Changes: 1990-present</span><span class="co">](https://www.cdc.gov/nchs/nvss/bridged_race/county_geography-_changes1990-present.pdf)</span>.</span>
<span id="cb130-67"><a href="#cb130-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-68"><a href="#cb130-68" aria-hidden="true" tabindex="-1"></a><span class="fu"># Datasets</span></span>
<span id="cb130-69"><a href="#cb130-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-70"><a href="#cb130-70" aria-hidden="true" tabindex="-1"></a><span class="fu">## Load Data</span></span>
<span id="cb130-71"><a href="#cb130-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-74"><a href="#cb130-74" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-75"><a href="#cb130-75" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load_datasets</span></span>
<span id="cb130-76"><a href="#cb130-76" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb130-77"><a href="#cb130-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the dataset from the prior step:</span></span>
<span id="cb130-78"><a href="#cb130-78" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="at">file =</span> <span class="st">"dataset/data_tx.RData"</span>)</span>
<span id="cb130-79"><a href="#cb130-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-80"><a href="#cb130-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the provider data:</span></span>
<span id="cb130-81"><a href="#cb130-81" aria-hidden="true" tabindex="-1"></a>prv <span class="ot">&lt;-</span> <span class="fu">read_fst</span>(<span class="at">path =</span> <span class="st">"dataset/prv.fst"</span>)</span>
<span id="cb130-82"><a href="#cb130-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-83"><a href="#cb130-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Download the US counties 2013 dataset from the Census Bureau using the `tigris` package:</span></span>
<span id="cb130-84"><a href="#cb130-84" aria-hidden="true" tabindex="-1"></a>counties_2013 <span class="ot">&lt;-</span> <span class="fu">counties</span>(<span class="at">year =</span> <span class="dv">2013</span>, <span class="at">cb =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-85"><a href="#cb130-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fips =</span> <span class="fu">paste0</span>(STATEFP, COUNTYFP)) <span class="sc">|&gt;</span></span>
<span id="cb130-86"><a href="#cb130-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(fips, <span class="at">.after =</span> COUNTYFP)</span>
<span id="cb130-87"><a href="#cb130-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-88"><a href="#cb130-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the USGS Populated Places dataset:</span></span>
<span id="cb130-89"><a href="#cb130-89" aria-hidden="true" tabindex="-1"></a>usgs <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(</span>
<span id="cb130-90"><a href="#cb130-90" aria-hidden="true" tabindex="-1"></a>  <span class="st">"data/Text/PopulatedPlaces_National.txt"</span>,</span>
<span id="cb130-91"><a href="#cb130-91" aria-hidden="true" tabindex="-1"></a>  <span class="at">delim =</span> <span class="st">"|"</span>, <span class="co"># the file is pipe-delimited</span></span>
<span id="cb130-92"><a href="#cb130-92" aria-hidden="true" tabindex="-1"></a>  <span class="at">col_names =</span> <span class="cn">TRUE</span>,</span>
<span id="cb130-93"><a href="#cb130-93" aria-hidden="true" tabindex="-1"></a>  <span class="at">progress =</span> <span class="cn">FALSE</span>)</span>
<span id="cb130-94"><a href="#cb130-94" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-95"><a href="#cb130-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-96"><a href="#cb130-96" aria-hidden="true" tabindex="-1"></a>Prepping a 'wide' dataset (the extensive munging is to create a dataset in which each row uniquely maps a state/name pair to a county, see 'USGS Diagnostics' section):</span>
<span id="cb130-97"><a href="#cb130-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-100"><a href="#cb130-100" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-101"><a href="#cb130-101" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: usgs_wide</span></span>
<span id="cb130-102"><a href="#cb130-102" aria-hidden="true" tabindex="-1"></a>usgs_wide <span class="ot">&lt;-</span> usgs <span class="sc">|&gt;</span></span>
<span id="cb130-103"><a href="#cb130-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state_numeric, county_numeric, map_name, feature_name) <span class="sc">|&gt;</span></span>
<span id="cb130-104"><a href="#cb130-104" aria-hidden="true" tabindex="-1"></a>  <span class="co"># lengthen the dataset by map name and feature name</span></span>
<span id="cb130-105"><a href="#cb130-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb130-106"><a href="#cb130-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(map_name, feature_name),</span>
<span id="cb130-107"><a href="#cb130-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"type"</span>,</span>
<span id="cb130-108"><a href="#cb130-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"name"</span></span>
<span id="cb130-109"><a href="#cb130-109" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb130-110"><a href="#cb130-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create new vars to count the 'type' of name in the row</span></span>
<span id="cb130-111"><a href="#cb130-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">str_to_lower</span>(name)) <span class="sc">|&gt;</span></span>
<span id="cb130-112"><a href="#cb130-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>type) <span class="sc">|&gt;</span></span>
<span id="cb130-113"><a href="#cb130-113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add fips0 variable</span></span>
<span id="cb130-114"><a href="#cb130-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fips0 =</span> <span class="fu">paste0</span>(state_numeric, county_numeric)) <span class="sc">|&gt;</span></span>
<span id="cb130-115"><a href="#cb130-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>county_numeric) <span class="sc">|&gt;</span></span>
<span id="cb130-116"><a href="#cb130-116" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tabulate number of FIPS codes for each state/name pair:</span></span>
<span id="cb130-117"><a href="#cb130-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(state_numeric, name) <span class="sc">|&gt;</span></span>
<span id="cb130-118"><a href="#cb130-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_fips =</span> <span class="fu">length</span>(<span class="fu">unique</span>(fips0))) <span class="sc">|&gt;</span></span>
<span id="cb130-119"><a href="#cb130-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb130-120"><a href="#cb130-120" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select only rows in which the state/name pair correspond to a single FIPS (i.e. n_fips == 1)</span></span>
<span id="cb130-121"><a href="#cb130-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_fips <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-122"><a href="#cb130-122" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove n_fips</span></span>
<span id="cb130-123"><a href="#cb130-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>n_fips) <span class="sc">|&gt;</span></span>
<span id="cb130-124"><a href="#cb130-124" aria-hidden="true" tabindex="-1"></a>  <span class="co"># retain only unique entries</span></span>
<span id="cb130-125"><a href="#cb130-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">|&gt;</span></span>
<span id="cb130-126"><a href="#cb130-126" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select counties present in 2013 only</span></span>
<span id="cb130-127"><a href="#cb130-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(fips0 <span class="sc">%in%</span> counties_2013<span class="sc">$</span>fips)</span>
<span id="cb130-128"><a href="#cb130-128" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-129"><a href="#cb130-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-130"><a href="#cb130-130" aria-hidden="true" tabindex="-1"></a><span class="fu">## Gelocation dataset</span></span>
<span id="cb130-131"><a href="#cb130-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-132"><a href="#cb130-132" aria-hidden="true" tabindex="-1"></a>The following code will create a reduced dataset without entries in the excluded locales described above; NB this step reduces the number of observations in the dataset.  A number of typos are corrected and the missing values from the provider dataset are also tabulated:</span>
<span id="cb130-133"><a href="#cb130-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-136"><a href="#cb130-136" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-137"><a href="#cb130-137" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: geolocation_dataset</span></span>
<span id="cb130-138"><a href="#cb130-138" aria-hidden="true" tabindex="-1"></a>data_fips <span class="ot">&lt;-</span> data_tx <span class="sc">|&gt;</span></span>
<span id="cb130-139"><a href="#cb130-139" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter out Puerto Rico, Virgin Islands, and Guam; these are not in NCHSUR  (codes 66, 72, 78):</span></span>
<span id="cb130-140"><a href="#cb130-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Prscrbr_State_FIPS <span class="sc">!=</span> <span class="st">"66"</span> <span class="sc">&amp;</span> Prscrbr_State_FIPS <span class="sc">!=</span> <span class="st">"72"</span> <span class="sc">&amp;</span> Prscrbr_State_FIPS <span class="sc">!=</span> <span class="st">"78"</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-141"><a href="#cb130-141" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter out military mail codes (codes AA, AE, AP); other codes (ZZ, XX):</span></span>
<span id="cb130-142"><a href="#cb130-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(Prscrbr_State_Abrvtn, <span class="st">"AA"</span>) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">str_detect</span>(Prscrbr_State_Abrvtn, <span class="st">"AE"</span>) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">str_detect</span>(Prscrbr_State_Abrvtn, <span class="st">"AP"</span>) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">str_detect</span>(Prscrbr_State_Abrvtn, <span class="st">"ZZ"</span>) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">str_detect</span>(Prscrbr_State_Abrvtn, <span class="st">"XX"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb130-143"><a href="#cb130-143" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter out missing state fips:</span></span>
<span id="cb130-144"><a href="#cb130-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Prscrbr_State_FIPS)) <span class="sc">|&gt;</span></span>
<span id="cb130-145"><a href="#cb130-145" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create a new variable to facilitate matching on the City by converting to lower case</span></span>
<span id="cb130-146"><a href="#cb130-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">city_fixed =</span> <span class="fu">str_to_lower</span>(Prscrbr_City)) <span class="sc">|&gt;</span></span>
<span id="cb130-147"><a href="#cb130-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-148"><a href="#cb130-148" aria-hidden="true" tabindex="-1"></a>  <span class="do">## join to prv dataset for RUCA, address, ZIP:</span></span>
<span id="cb130-149"><a href="#cb130-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb130-150"><a href="#cb130-150" aria-hidden="true" tabindex="-1"></a>    prv[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">13</span>,<span class="dv">14</span>,<span class="dv">86</span>)],                       <span class="co"># y dataset</span></span>
<span id="cb130-151"><a href="#cb130-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">join_by</span>(</span>
<span id="cb130-152"><a href="#cb130-152" aria-hidden="true" tabindex="-1"></a>      Prscrbr_NPI <span class="sc">==</span> PRSCRBR_NPI,</span>
<span id="cb130-153"><a href="#cb130-153" aria-hidden="true" tabindex="-1"></a>      year <span class="sc">==</span> year),</span>
<span id="cb130-154"><a href="#cb130-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">relationship =</span> <span class="st">"many-to-one"</span>                  <span class="co"># left_join will not work without specifying this relation</span></span>
<span id="cb130-155"><a href="#cb130-155" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb130-156"><a href="#cb130-156" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compile address variable</span></span>
<span id="cb130-157"><a href="#cb130-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">address =</span> <span class="fu">paste0</span>(Prscrbr_St1, <span class="st">", "</span>, Prscrbr_City, <span class="st">", "</span>, Prscrbr_State_Abrvtn, <span class="st">" "</span>, Prscrbr_zip5)) <span class="sc">|&gt;</span></span>
<span id="cb130-158"><a href="#cb130-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-159"><a href="#cb130-159" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Correct typos:</span></span>
<span id="cb130-160"><a href="#cb130-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Prscrbr_State_Abrvtn =</span> <span class="fu">if_else</span>(</span>
<span id="cb130-161"><a href="#cb130-161" aria-hidden="true" tabindex="-1"></a>    address <span class="sc">==</span> <span class="st">"1149 Bloomfield Ave, Clifton, NY 07012"</span>,</span>
<span id="cb130-162"><a href="#cb130-162" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NJ"</span>,</span>
<span id="cb130-163"><a href="#cb130-163" aria-hidden="true" tabindex="-1"></a>    Prscrbr_State_Abrvtn)) <span class="sc">|&gt;</span></span>
<span id="cb130-164"><a href="#cb130-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Prscrbr_State_Abrvtn =</span> <span class="fu">if_else</span>(</span>
<span id="cb130-165"><a href="#cb130-165" aria-hidden="true" tabindex="-1"></a>    address <span class="sc">==</span> <span class="st">"209 Highway 18 South, East Brunswick, PA 08816"</span>,</span>
<span id="cb130-166"><a href="#cb130-166" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NJ"</span>,</span>
<span id="cb130-167"><a href="#cb130-167" aria-hidden="true" tabindex="-1"></a>    Prscrbr_State_Abrvtn)) <span class="sc">|&gt;</span></span>
<span id="cb130-168"><a href="#cb130-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Prscrbr_State_Abrvtn =</span> <span class="fu">if_else</span>(</span>
<span id="cb130-169"><a href="#cb130-169" aria-hidden="true" tabindex="-1"></a>    address <span class="sc">==</span> <span class="st">"1590-01 Constitution Boulvard, Rock Hill, CA 29732"</span>,</span>
<span id="cb130-170"><a href="#cb130-170" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SC"</span>,</span>
<span id="cb130-171"><a href="#cb130-171" aria-hidden="true" tabindex="-1"></a>    Prscrbr_State_Abrvtn)) <span class="sc">|&gt;</span></span>
<span id="cb130-172"><a href="#cb130-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Prscrbr_State_Abrvtn =</span> <span class="fu">if_else</span>(</span>
<span id="cb130-173"><a href="#cb130-173" aria-hidden="true" tabindex="-1"></a>    address <span class="sc">==</span> <span class="st">"209 Nw 8th St, Seminole, NM 79360"</span>,</span>
<span id="cb130-174"><a href="#cb130-174" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TX"</span>,</span>
<span id="cb130-175"><a href="#cb130-175" aria-hidden="true" tabindex="-1"></a>    Prscrbr_State_Abrvtn)) <span class="sc">|&gt;</span></span>
<span id="cb130-176"><a href="#cb130-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Prscrbr_State_Abrvtn =</span> <span class="fu">if_else</span>(</span>
<span id="cb130-177"><a href="#cb130-177" aria-hidden="true" tabindex="-1"></a>    address <span class="sc">==</span> <span class="st">"1149 Bloomfield Ave, Clifton, NY 07012"</span>,</span>
<span id="cb130-178"><a href="#cb130-178" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NJ"</span>,</span>
<span id="cb130-179"><a href="#cb130-179" aria-hidden="true" tabindex="-1"></a>    Prscrbr_State_Abrvtn)) <span class="sc">|&gt;</span></span>
<span id="cb130-180"><a href="#cb130-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Prscrbr_State_Abrvtn =</span> <span class="fu">if_else</span>(</span>
<span id="cb130-181"><a href="#cb130-181" aria-hidden="true" tabindex="-1"></a>    address <span class="sc">==</span> <span class="st">"365 Montauk Ave, New London, TN 06320"</span>,</span>
<span id="cb130-182"><a href="#cb130-182" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CT"</span>,</span>
<span id="cb130-183"><a href="#cb130-183" aria-hidden="true" tabindex="-1"></a>    Prscrbr_State_Abrvtn)) <span class="sc">|&gt;</span></span>
<span id="cb130-184"><a href="#cb130-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Prscrbr_State_Abrvtn =</span> <span class="fu">if_else</span>(</span>
<span id="cb130-185"><a href="#cb130-185" aria-hidden="true" tabindex="-1"></a>    address <span class="sc">==</span> <span class="st">"8687 Connecticut St, Merillville, IL 46410"</span>,</span>
<span id="cb130-186"><a href="#cb130-186" aria-hidden="true" tabindex="-1"></a>    <span class="st">"IN"</span>,</span>
<span id="cb130-187"><a href="#cb130-187" aria-hidden="true" tabindex="-1"></a>    Prscrbr_State_Abrvtn)) <span class="sc">|&gt;</span></span>
<span id="cb130-188"><a href="#cb130-188" aria-hidden="true" tabindex="-1"></a>  <span class="co"># exclude the military zip</span></span>
<span id="cb130-189"><a href="#cb130-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Prscrbr_zip5 <span class="sc">!=</span> <span class="dv">96555</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-190"><a href="#cb130-190" aria-hidden="true" tabindex="-1"></a>  <span class="co"># correct Lake Mary, FL city and Zip</span></span>
<span id="cb130-191"><a href="#cb130-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Prscrbr_City =</span> <span class="fu">ifelse</span>(Prscrbr_zip5 <span class="sc">==</span> <span class="dv">32476</span>, <span class="st">"Lake Mary"</span>, Prscrbr_City)) <span class="sc">|&gt;</span></span>
<span id="cb130-192"><a href="#cb130-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Prscrbr_zip5 =</span> <span class="fu">ifelse</span>(Prscrbr_zip5 <span class="sc">==</span> <span class="dv">32476</span>, <span class="dv">32746</span>, Prscrbr_zip5)) <span class="sc">|&gt;</span></span>
<span id="cb130-193"><a href="#cb130-193" aria-hidden="true" tabindex="-1"></a>  <span class="co"># re-compile address variable</span></span>
<span id="cb130-194"><a href="#cb130-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">address =</span> <span class="fu">paste0</span>(Prscrbr_St1, <span class="st">", "</span>, Prscrbr_City, <span class="st">", "</span>, Prscrbr_State_Abrvtn, <span class="st">" "</span>, Prscrbr_zip5))</span>
<span id="cb130-195"><a href="#cb130-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-196"><a href="#cb130-196" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of missing values from provider dataset</span></span>
<span id="cb130-197"><a href="#cb130-197" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(data_fips<span class="sc">$</span>Prscrbr_RUCA))</span>
<span id="cb130-198"><a href="#cb130-198" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(data_fips<span class="sc">$</span>Prscrbr_zip5))</span>
<span id="cb130-199"><a href="#cb130-199" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(data_fips<span class="sc">$</span>Prscrbr_St1))</span>
<span id="cb130-200"><a href="#cb130-200" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-201"><a href="#cb130-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-202"><a href="#cb130-202" aria-hidden="true" tabindex="-1"></a><span class="fu">## USGS Diagnostics</span></span>
<span id="cb130-203"><a href="#cb130-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-204"><a href="#cb130-204" aria-hidden="true" tabindex="-1"></a>It is possible that a single name/state pair could match to multiple different FIPS codes in the unmodified dataset; let's see if that is the case:</span>
<span id="cb130-205"><a href="#cb130-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-208"><a href="#cb130-208" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-209"><a href="#cb130-209" aria-hidden="true" tabindex="-1"></a><span class="co"># number of unique state/map_name combinations</span></span>
<span id="cb130-210"><a href="#cb130-210" aria-hidden="true" tabindex="-1"></a>usgs <span class="sc">|&gt;</span></span>
<span id="cb130-211"><a href="#cb130-211" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add variables for fips and convert text-formatted date_created variable to a proper date</span></span>
<span id="cb130-212"><a href="#cb130-212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fips =</span> <span class="fu">paste0</span>(state_numeric, county_numeric)) <span class="sc">|&gt;</span></span>
<span id="cb130-213"><a href="#cb130-213" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select counties present in 2013 only</span></span>
<span id="cb130-214"><a href="#cb130-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(fips <span class="sc">%in%</span> counties_2013<span class="sc">$</span>fips) <span class="sc">|&gt;</span>   </span>
<span id="cb130-215"><a href="#cb130-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state_numeric, map_name) <span class="sc">|&gt;</span></span>
<span id="cb130-216"><a href="#cb130-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb130-217"><a href="#cb130-217" aria-hidden="true" tabindex="-1"></a><span class="co"># number of unique fips/map_name combinations</span></span>
<span id="cb130-218"><a href="#cb130-218" aria-hidden="true" tabindex="-1"></a>usgs <span class="sc">|&gt;</span></span>
<span id="cb130-219"><a href="#cb130-219" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add variables for fips and convert text-formatted date_created variable to a proper date</span></span>
<span id="cb130-220"><a href="#cb130-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fips =</span> <span class="fu">paste0</span>(state_numeric, county_numeric)) <span class="sc">|&gt;</span></span>
<span id="cb130-221"><a href="#cb130-221" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select counties present in 2013 only</span></span>
<span id="cb130-222"><a href="#cb130-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(fips <span class="sc">%in%</span> counties_2013<span class="sc">$</span>fips) <span class="sc">|&gt;</span>   </span>
<span id="cb130-223"><a href="#cb130-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state_numeric, map_name, county_numeric) <span class="sc">|&gt;</span></span>
<span id="cb130-224"><a href="#cb130-224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb130-225"><a href="#cb130-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-226"><a href="#cb130-226" aria-hidden="true" tabindex="-1"></a><span class="co"># number of unique state/feature_name combinations</span></span>
<span id="cb130-227"><a href="#cb130-227" aria-hidden="true" tabindex="-1"></a>usgs <span class="sc">|&gt;</span></span>
<span id="cb130-228"><a href="#cb130-228" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add variables for fips and convert text-formatted date_created variable to a proper date</span></span>
<span id="cb130-229"><a href="#cb130-229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fips =</span> <span class="fu">paste0</span>(state_numeric, county_numeric)) <span class="sc">|&gt;</span></span>
<span id="cb130-230"><a href="#cb130-230" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select counties present in 2013 only</span></span>
<span id="cb130-231"><a href="#cb130-231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(fips <span class="sc">%in%</span> counties_2013<span class="sc">$</span>fips) <span class="sc">|&gt;</span>   </span>
<span id="cb130-232"><a href="#cb130-232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state_numeric, feature_name) <span class="sc">|&gt;</span></span>
<span id="cb130-233"><a href="#cb130-233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb130-234"><a href="#cb130-234" aria-hidden="true" tabindex="-1"></a><span class="co"># number of unique fips/feature_name combinations</span></span>
<span id="cb130-235"><a href="#cb130-235" aria-hidden="true" tabindex="-1"></a>usgs <span class="sc">|&gt;</span></span>
<span id="cb130-236"><a href="#cb130-236" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add variables for fips and convert text-formatted date_created variable to a proper date</span></span>
<span id="cb130-237"><a href="#cb130-237" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fips =</span> <span class="fu">paste0</span>(state_numeric, county_numeric)) <span class="sc">|&gt;</span></span>
<span id="cb130-238"><a href="#cb130-238" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select counties present in 2013 only</span></span>
<span id="cb130-239"><a href="#cb130-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(fips <span class="sc">%in%</span> counties_2013<span class="sc">$</span>fips) <span class="sc">|&gt;</span>   </span>
<span id="cb130-240"><a href="#cb130-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state_numeric, feature_name, county_numeric) <span class="sc">|&gt;</span></span>
<span id="cb130-241"><a href="#cb130-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb130-242"><a href="#cb130-242" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-243"><a href="#cb130-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-244"><a href="#cb130-244" aria-hidden="true" tabindex="-1"></a>It appears that there are non-unique combinations of state FIPS and map_name, as well as non-unique combinations of state FIPS and feature_name.  We don't want to randomly assign FIPS values to these entries, so we will need to create reduced datasets to match on containing only the unique pairs.</span>
<span id="cb130-245"><a href="#cb130-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-246"><a href="#cb130-246" aria-hidden="true" tabindex="-1"></a><span class="fu">## Examining excluded locales</span></span>
<span id="cb130-247"><a href="#cb130-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-248"><a href="#cb130-248" aria-hidden="true" tabindex="-1"></a>Before proceeding, entries from Puerto Rico, Virgin Islands, and Guam and/or any entries with a military mail code, or a missing address will be examined, as they will be filtered out in the next step:</span>
<span id="cb130-249"><a href="#cb130-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-252"><a href="#cb130-252" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-253"><a href="#cb130-253" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: OUD_summary</span></span>
<span id="cb130-254"><a href="#cb130-254" aria-hidden="true" tabindex="-1"></a>filtered_geo <span class="ot">&lt;-</span> data_tx <span class="sc">|&gt;</span></span>
<span id="cb130-255"><a href="#cb130-255" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb130-256"><a href="#cb130-256" aria-hidden="true" tabindex="-1"></a>    <span class="co"># select Puerto Rico, Virgin Islands, and Guam; these are not in NCHSUR  (codes 66, 72, 78), or NA:</span></span>
<span id="cb130-257"><a href="#cb130-257" aria-hidden="true" tabindex="-1"></a>    Prscrbr_State_FIPS <span class="sc">==</span> <span class="st">"66"</span> <span class="sc">|</span> Prscrbr_State_FIPS <span class="sc">==</span> <span class="st">"72"</span> <span class="sc">|</span> Prscrbr_State_FIPS <span class="sc">==</span> <span class="st">"78"</span> <span class="sc">|</span> <span class="fu">is.na</span>(Prscrbr_State_FIPS) <span class="sc">|</span></span>
<span id="cb130-258"><a href="#cb130-258" aria-hidden="true" tabindex="-1"></a>    <span class="co"># select military mail codes (codes AA, AE, AP); other codes (ZZ, XX):</span></span>
<span id="cb130-259"><a href="#cb130-259" aria-hidden="true" tabindex="-1"></a>    Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"AA"</span> <span class="sc">|</span> Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"AE"</span> <span class="sc">|</span> Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"AP"</span> <span class="sc">|</span> Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"ZZ"</span> <span class="sc">|</span> Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"XX"</span>)</span>
<span id="cb130-260"><a href="#cb130-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-261"><a href="#cb130-261" aria-hidden="true" tabindex="-1"></a><span class="co"># create a summary table by Prscrbr_State_Abrvtn of buprenorphine prescribers:</span></span>
<span id="cb130-262"><a href="#cb130-262" aria-hidden="true" tabindex="-1"></a>filtered_geo <span class="sc">|&gt;</span></span>
<span id="cb130-263"><a href="#cb130-263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(MAT_generic <span class="sc">==</span> <span class="st">"bup"</span> <span class="sc">|</span> MAT_brand <span class="sc">==</span> <span class="st">"bup"</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-264"><a href="#cb130-264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Prscrbr_State_Abrvtn, tx) <span class="sc">|&gt;</span></span>
<span id="cb130-265"><a href="#cb130-265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">N_prescribers =</span> <span class="fu">n</span>(), <span class="at">patient_years_supplied =</span> <span class="fu">sum</span>(Tot_Day_Suply<span class="sc">/</span><span class="dv">365</span>)) <span class="sc">|&gt;</span></span>
<span id="cb130-266"><a href="#cb130-266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(patient_years_supplied)) <span class="sc">|&gt;</span></span>
<span id="cb130-267"><a href="#cb130-267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">adorn_totals</span>()</span>
<span id="cb130-268"><a href="#cb130-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-269"><a href="#cb130-269" aria-hidden="true" tabindex="-1"></a><span class="co"># create a summary table by Prscrbr_State_Abrvtn of buprenorphine prescribers:</span></span>
<span id="cb130-270"><a href="#cb130-270" aria-hidden="true" tabindex="-1"></a>filtered_geo <span class="sc">|&gt;</span></span>
<span id="cb130-271"><a href="#cb130-271" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(MAT_generic <span class="sc">==</span> <span class="st">"met"</span> <span class="sc">|</span> MAT_brand <span class="sc">==</span> <span class="st">"met"</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-272"><a href="#cb130-272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Prscrbr_State_Abrvtn, tx) <span class="sc">|&gt;</span></span>
<span id="cb130-273"><a href="#cb130-273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">N_prescribers =</span> <span class="fu">n</span>(), <span class="at">patient_years_supplied =</span> <span class="fu">sum</span>(Tot_Day_Suply<span class="sc">/</span><span class="dv">365</span>)) <span class="sc">|&gt;</span></span>
<span id="cb130-274"><a href="#cb130-274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(patient_years_supplied)) <span class="sc">|&gt;</span></span>
<span id="cb130-275"><a href="#cb130-275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">adorn_totals</span>()</span>
<span id="cb130-276"><a href="#cb130-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-277"><a href="#cb130-277" aria-hidden="true" tabindex="-1"></a><span class="co"># create a summary table by Prscrbr_State_Abrvtn of buprenorphine prescribers:</span></span>
<span id="cb130-278"><a href="#cb130-278" aria-hidden="true" tabindex="-1"></a>filtered_geo <span class="sc">|&gt;</span></span>
<span id="cb130-279"><a href="#cb130-279" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(MAT_generic <span class="sc">==</span> <span class="st">"nal"</span> <span class="sc">|</span> MAT_brand <span class="sc">==</span> <span class="st">"nal"</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-280"><a href="#cb130-280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Prscrbr_State_Abrvtn, tx) <span class="sc">|&gt;</span></span>
<span id="cb130-281"><a href="#cb130-281" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">N_prescribers =</span> <span class="fu">n</span>(), <span class="at">patient_years_supplied =</span> <span class="fu">sum</span>(Tot_Day_Suply<span class="sc">/</span><span class="dv">365</span>)) <span class="sc">|&gt;</span></span>
<span id="cb130-282"><a href="#cb130-282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(patient_years_supplied)) <span class="sc">|&gt;</span></span>
<span id="cb130-283"><a href="#cb130-283" aria-hidden="true" tabindex="-1"></a>  <span class="fu">adorn_totals</span>()</span>
<span id="cb130-284"><a href="#cb130-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-285"><a href="#cb130-285" aria-hidden="true" tabindex="-1"></a><span class="co"># Some cleanup:</span></span>
<span id="cb130-286"><a href="#cb130-286" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(filtered_geo, counties_2013, data_tx, prv, usgs)</span>
<span id="cb130-287"><a href="#cb130-287" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-288"><a href="#cb130-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-289"><a href="#cb130-289" aria-hidden="true" tabindex="-1"></a><span class="fu"># Geolocation</span></span>
<span id="cb130-290"><a href="#cb130-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-291"><a href="#cb130-291" aria-hidden="true" tabindex="-1"></a><span class="fu">## 0 &amp; 1: Searching USGS dataset &amp; geocoding from zip</span></span>
<span id="cb130-292"><a href="#cb130-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-293"><a href="#cb130-293" aria-hidden="true" tabindex="-1"></a>We can now search the USGS dataset for the FIPS code corresponding to the city/state pair in the CDC dataset:</span>
<span id="cb130-294"><a href="#cb130-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-297"><a href="#cb130-297" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-298"><a href="#cb130-298" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: search_USGS_zip</span></span>
<span id="cb130-299"><a href="#cb130-299" aria-hidden="true" tabindex="-1"></a><span class="co"># search USGS:</span></span>
<span id="cb130-300"><a href="#cb130-300" aria-hidden="true" tabindex="-1"></a>data_fips <span class="ot">&lt;-</span> <span class="fu">left_join</span>(data_fips,                      <span class="co"># x dataset</span></span>
<span id="cb130-301"><a href="#cb130-301" aria-hidden="true" tabindex="-1"></a>  usgs_wide,                                           <span class="co"># y dataset</span></span>
<span id="cb130-302"><a href="#cb130-302" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">join_by</span>(</span>
<span id="cb130-303"><a href="#cb130-303" aria-hidden="true" tabindex="-1"></a>    Prscrbr_State_FIPS <span class="sc">==</span> state_numeric,</span>
<span id="cb130-304"><a href="#cb130-304" aria-hidden="true" tabindex="-1"></a>    city_fixed <span class="sc">==</span> name),</span>
<span id="cb130-305"><a href="#cb130-305" aria-hidden="true" tabindex="-1"></a>  <span class="at">relationship =</span> <span class="st">"many-to-one"</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-306"><a href="#cb130-306" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geocode from zipcode centroid &amp; reverse to fips:</span></span>
<span id="cb130-307"><a href="#cb130-307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb130-308"><a href="#cb130-308" aria-hidden="true" tabindex="-1"></a>    data_fips<span class="sc">$</span>Prscrbr_zip5 <span class="sc">|&gt;</span>                          <span class="co"># y dataset</span></span>
<span id="cb130-309"><a href="#cb130-309" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unique</span>() <span class="sc">|&gt;</span>                                      <span class="co"># y dataset</span></span>
<span id="cb130-310"><a href="#cb130-310" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geocode_zip</span>() <span class="sc">|&gt;</span>                                 <span class="co"># y dataset</span></span>
<span id="cb130-311"><a href="#cb130-311" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">fips1 =</span> <span class="fu">coords_to_fips</span>(<span class="at">x =</span> lng, <span class="at">y =</span> lat)),<span class="co"># y dataset</span></span>
<span id="cb130-312"><a href="#cb130-312" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">join_by</span>(Prscrbr_zip5 <span class="sc">==</span> zipcode),</span>
<span id="cb130-313"><a href="#cb130-313" aria-hidden="true" tabindex="-1"></a>    <span class="at">relationship =</span> <span class="st">"many-to-one"</span>) <span class="sc">|&gt;</span>          </span>
<span id="cb130-314"><a href="#cb130-314" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add variables for diagnosis</span></span>
<span id="cb130-315"><a href="#cb130-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb130-316"><a href="#cb130-316" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get the state abbreviation</span></span>
<span id="cb130-317"><a href="#cb130-317" aria-hidden="true" tabindex="-1"></a>    <span class="at">State_Abbrevtn =</span> <span class="fu">fips_abbr</span>(fips1),</span>
<span id="cb130-318"><a href="#cb130-318" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check if the state is correct</span></span>
<span id="cb130-319"><a href="#cb130-319" aria-hidden="true" tabindex="-1"></a>    <span class="at">miss_state1 =</span> <span class="fu">if_else</span>(Prscrbr_State_Abrvtn <span class="sc">==</span> State_Abbrevtn,</span>
<span id="cb130-320"><a href="#cb130-320" aria-hidden="true" tabindex="-1"></a>                         <span class="dv">0</span>, <span class="dv">1</span>, <span class="at">missing =</span> <span class="dv">2</span>),</span>
<span id="cb130-321"><a href="#cb130-321" aria-hidden="true" tabindex="-1"></a>    <span class="co"># document the query</span></span>
<span id="cb130-322"><a href="#cb130-322" aria-hidden="true" tabindex="-1"></a>    <span class="at">query0 =</span> <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(fips0),</span>
<span id="cb130-323"><a href="#cb130-323" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"USGS"</span>,</span>
<span id="cb130-324"><a href="#cb130-324" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(fips1) <span class="sc">&amp;</span> miss_state1 <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb130-325"><a href="#cb130-325" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"zip"</span>,</span>
<span id="cb130-326"><a href="#cb130-326" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"geo"</span>)),</span>
<span id="cb130-327"><a href="#cb130-327" aria-hidden="true" tabindex="-1"></a>    <span class="at">fips =</span> <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(fips0),</span>
<span id="cb130-328"><a href="#cb130-328" aria-hidden="true" tabindex="-1"></a>                    fips0,</span>
<span id="cb130-329"><a href="#cb130-329" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(fips1) <span class="sc">&amp;</span> miss_state1 <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb130-330"><a href="#cb130-330" aria-hidden="true" tabindex="-1"></a>                            fips1,</span>
<span id="cb130-331"><a href="#cb130-331" aria-hidden="true" tabindex="-1"></a>                            <span class="cn">NA</span>))) <span class="sc">|&gt;</span></span>
<span id="cb130-332"><a href="#cb130-332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>lat, <span class="sc">-</span>lng, <span class="sc">-</span>State_Abbrevtn)</span>
<span id="cb130-333"><a href="#cb130-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-334"><a href="#cb130-334" aria-hidden="true" tabindex="-1"></a><span class="co"># diagnostics:</span></span>
<span id="cb130-335"><a href="#cb130-335" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span></span>
<span id="cb130-336"><a href="#cb130-336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(query0) <span class="sc">|&gt;</span></span>
<span id="cb130-337"><a href="#cb130-337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb130-338"><a href="#cb130-338" aria-hidden="true" tabindex="-1"></a>    <span class="at">Missing_fips =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(fips)),</span>
<span id="cb130-339"><a href="#cb130-339" aria-hidden="true" tabindex="-1"></a>    <span class="at">Miss_USGS =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(fips0)),</span>
<span id="cb130-340"><a href="#cb130-340" aria-hidden="true" tabindex="-1"></a>    <span class="at">Miss_ZIP =</span> <span class="fu">sum</span>(miss_state1 <span class="sc">!=</span> <span class="dv">0</span>),</span>
<span id="cb130-341"><a href="#cb130-341" aria-hidden="true" tabindex="-1"></a>    <span class="at">N_city_state_combo =</span> <span class="fu">n_distinct</span>(Prscrbr_City, Prscrbr_State_FIPS),</span>
<span id="cb130-342"><a href="#cb130-342" aria-hidden="true" tabindex="-1"></a>    <span class="at">N_addresses =</span> <span class="fu">n_distinct</span>(address),</span>
<span id="cb130-343"><a href="#cb130-343" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> <span class="fu">n</span>()</span>
<span id="cb130-344"><a href="#cb130-344" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb130-345"><a href="#cb130-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(N) <span class="sc">|&gt;</span></span>
<span id="cb130-346"><a href="#cb130-346" aria-hidden="true" tabindex="-1"></a>  <span class="fu">adorn_totals</span>()</span>
<span id="cb130-347"><a href="#cb130-347" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-348"><a href="#cb130-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-349"><a href="#cb130-349" aria-hidden="true" tabindex="-1"></a>It appears that ~70% of city/state combos were resolved with the USGS dataset.  Furthermore the bulk of the unresolved entries seem to have city/state pairs in highly populated areas, where place names likely do not uniquely resolve to counties.  Thus we can find more information on these providers in the <span class="co">[</span><span class="ot">Medicare Part D Prescribers - by Provider</span><span class="co">](https://data.cms.gov/provider-summary-by-type-of-service/medicare-part-d-prescribers/medicare-part-d-prescribers-by-provider)</span> dataset, and then lookup their fips via geolocation.</span>
<span id="cb130-350"><a href="#cb130-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-351"><a href="#cb130-351" aria-hidden="true" tabindex="-1"></a><span class="fu">### Addresses for geocoding</span></span>
<span id="cb130-352"><a href="#cb130-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-353"><a href="#cb130-353" aria-hidden="true" tabindex="-1"></a>We will now create a dataset containing the address to geocode; these will include all addresses not resolved with the USGS dataset, and a random sampling of those successfully resolved:</span>
<span id="cb130-354"><a href="#cb130-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-357"><a href="#cb130-357" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-358"><a href="#cb130-358" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: addresses</span></span>
<span id="cb130-359"><a href="#cb130-359" aria-hidden="true" tabindex="-1"></a><span class="co"># set seed for slice_sample function</span></span>
<span id="cb130-360"><a href="#cb130-360" aria-hidden="true" tabindex="-1"></a>seed <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">Sys.time</span>())</span>
<span id="cb130-361"><a href="#cb130-361" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(seed)</span>
<span id="cb130-362"><a href="#cb130-362" aria-hidden="true" tabindex="-1"></a>seed</span>
<span id="cb130-363"><a href="#cb130-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-364"><a href="#cb130-364" aria-hidden="true" tabindex="-1"></a><span class="co"># create list of addresses</span></span>
<span id="cb130-365"><a href="#cb130-365" aria-hidden="true" tabindex="-1"></a>addresses <span class="ot">&lt;-</span> data_fips <span class="sc">|&gt;</span></span>
<span id="cb130-366"><a href="#cb130-366" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selecting unmatched entries</span></span>
<span id="cb130-367"><a href="#cb130-367" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(query0 <span class="sc">==</span> <span class="st">"geo"</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-368"><a href="#cb130-368" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(address, Prscrbr_St1, Prscrbr_City, Prscrbr_State_Abrvtn, Prscrbr_zip5, miss_state1, query0, fips) <span class="sc">|&gt;</span></span>
<span id="cb130-369"><a href="#cb130-369" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">|&gt;</span></span>
<span id="cb130-370"><a href="#cb130-370" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">group =</span> <span class="st">"geocode"</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-371"><a href="#cb130-371" aria-hidden="true" tabindex="-1"></a>  <span class="do">## binding to randomly chosen entries</span></span>
<span id="cb130-372"><a href="#cb130-372" aria-hidden="true" tabindex="-1"></a>  <span class="co"># entries which matched to USGS and ZIP</span></span>
<span id="cb130-373"><a href="#cb130-373" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(</span>
<span id="cb130-374"><a href="#cb130-374" aria-hidden="true" tabindex="-1"></a>    data_fips <span class="sc">|&gt;</span></span>
<span id="cb130-375"><a href="#cb130-375" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(query0 <span class="sc">==</span> <span class="st">"USGS"</span> <span class="sc">&amp;</span> miss_state1 <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-376"><a href="#cb130-376" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(address, Prscrbr_St1, Prscrbr_City, Prscrbr_State_Abrvtn, Prscrbr_zip5, miss_state1, query0, fips) <span class="sc">|&gt;</span></span>
<span id="cb130-377"><a href="#cb130-377" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unique</span>() <span class="sc">|&gt;</span></span>
<span id="cb130-378"><a href="#cb130-378" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-379"><a href="#cb130-379" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">group =</span> <span class="st">"USGS &amp; Zip"</span>)</span>
<span id="cb130-380"><a href="#cb130-380" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb130-381"><a href="#cb130-381" aria-hidden="true" tabindex="-1"></a>  <span class="co"># entries which matched to USGS but not ZIP</span></span>
<span id="cb130-382"><a href="#cb130-382" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(</span>
<span id="cb130-383"><a href="#cb130-383" aria-hidden="true" tabindex="-1"></a>    data_fips <span class="sc">|&gt;</span></span>
<span id="cb130-384"><a href="#cb130-384" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(query0 <span class="sc">==</span> <span class="st">"USGS"</span> <span class="sc">&amp;</span> miss_state1 <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-385"><a href="#cb130-385" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(address, Prscrbr_St1, Prscrbr_City, Prscrbr_State_Abrvtn, Prscrbr_zip5, miss_state1, query0, fips) <span class="sc">|&gt;</span></span>
<span id="cb130-386"><a href="#cb130-386" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unique</span>() <span class="sc">|&gt;</span></span>
<span id="cb130-387"><a href="#cb130-387" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-388"><a href="#cb130-388" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">group =</span> <span class="st">"USGS"</span>)</span>
<span id="cb130-389"><a href="#cb130-389" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb130-390"><a href="#cb130-390" aria-hidden="true" tabindex="-1"></a>  <span class="co"># entries which matched to ZIP but not USGS</span></span>
<span id="cb130-391"><a href="#cb130-391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(</span>
<span id="cb130-392"><a href="#cb130-392" aria-hidden="true" tabindex="-1"></a>    data_fips <span class="sc">|&gt;</span></span>
<span id="cb130-393"><a href="#cb130-393" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(query0 <span class="sc">==</span> <span class="st">"zip"</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-394"><a href="#cb130-394" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(address, Prscrbr_St1, Prscrbr_City, Prscrbr_State_Abrvtn, Prscrbr_zip5, miss_state1, query0, fips) <span class="sc">|&gt;</span></span>
<span id="cb130-395"><a href="#cb130-395" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unique</span>() <span class="sc">|&gt;</span></span>
<span id="cb130-396"><a href="#cb130-396" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-397"><a href="#cb130-397" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">group =</span> <span class="st">"Zip"</span>)</span>
<span id="cb130-398"><a href="#cb130-398" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb130-399"><a href="#cb130-399" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-400"><a href="#cb130-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-401"><a href="#cb130-401" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2: Geocoding: census &gt; osm &gt; arcgis &gt; geoapify &gt; opencage &gt; mapbox</span></span>
<span id="cb130-402"><a href="#cb130-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-405"><a href="#cb130-405" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-406"><a href="#cb130-406" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load_addresses_2</span></span>
<span id="cb130-407"><a href="#cb130-407" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: FALSE</span></span>
<span id="cb130-408"><a href="#cb130-408" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: FALSE</span></span>
<span id="cb130-409"><a href="#cb130-409" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="at">file =</span> <span class="st">"dataset/addresses_2.RData"</span>,)</span>
<span id="cb130-410"><a href="#cb130-410" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-411"><a href="#cb130-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-412"><a href="#cb130-412" aria-hidden="true" tabindex="-1"></a>Define queries:</span>
<span id="cb130-413"><a href="#cb130-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-416"><a href="#cb130-416" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-417"><a href="#cb130-417" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: geocoding_queries</span></span>
<span id="cb130-418"><a href="#cb130-418" aria-hidden="true" tabindex="-1"></a>queries <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb130-419"><a href="#cb130-419" aria-hidden="true" tabindex="-1"></a>  <span class="at">service =</span> <span class="fu">c</span>(</span>
<span id="cb130-420"><a href="#cb130-420" aria-hidden="true" tabindex="-1"></a>    <span class="st">"census"</span></span>
<span id="cb130-421"><a href="#cb130-421" aria-hidden="true" tabindex="-1"></a>    , <span class="st">"arcgis"</span>      <span class="co"># limit 1?</span></span>
<span id="cb130-422"><a href="#cb130-422" aria-hidden="true" tabindex="-1"></a>    , <span class="st">"osm"</span>         <span class="co"># limit 1/s</span></span>
<span id="cb130-423"><a href="#cb130-423" aria-hidden="true" tabindex="-1"></a>    , <span class="st">"iq"</span>          <span class="co"># limit 1/s;    5000/d</span></span>
<span id="cb130-424"><a href="#cb130-424" aria-hidden="true" tabindex="-1"></a>    , <span class="st">"tomtom"</span>      <span class="co"># limit 5/s;    2500/d</span></span>
<span id="cb130-425"><a href="#cb130-425" aria-hidden="true" tabindex="-1"></a>    <span class="co"># , "mapbox"      # limit 10/s;   100000 free requests</span></span>
<span id="cb130-426"><a href="#cb130-426" aria-hidden="true" tabindex="-1"></a>    , <span class="st">"geoapify"</span>    <span class="co"># limit 5/s;    3000/d</span></span>
<span id="cb130-427"><a href="#cb130-427" aria-hidden="true" tabindex="-1"></a>    <span class="co"># , "opencage"  # limit reached, limit 1/s; 2500/d</span></span>
<span id="cb130-428"><a href="#cb130-428" aria-hidden="true" tabindex="-1"></a>    , <span class="st">"geocodio"</span>    <span class="co"># limit 16.7/s; 2500/d</span></span>
<span id="cb130-429"><a href="#cb130-429" aria-hidden="true" tabindex="-1"></a>    <span class="co"># , "here"        # limit 5/s;    1000/d</span></span>
<span id="cb130-430"><a href="#cb130-430" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb130-431"><a href="#cb130-431" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb130-432"><a href="#cb130-432" aria-hidden="true" tabindex="-1"></a>queries <span class="ot">&lt;-</span> queries <span class="sc">|&gt;</span></span>
<span id="cb130-433"><a href="#cb130-433" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb130-434"><a href="#cb130-434" aria-hidden="true" tabindex="-1"></a>    <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(queries),</span>
<span id="cb130-435"><a href="#cb130-435" aria-hidden="true" tabindex="-1"></a>    <span class="at">queries =</span> <span class="fu">list</span>(</span>
<span id="cb130-436"><a href="#cb130-436" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">method =</span> <span class="st">'census'</span>,</span>
<span id="cb130-437"><a href="#cb130-437" aria-hidden="true" tabindex="-1"></a>           <span class="at">street =</span> <span class="st">'Prscrbr_St1'</span>,</span>
<span id="cb130-438"><a href="#cb130-438" aria-hidden="true" tabindex="-1"></a>           <span class="at">city =</span> <span class="st">'Prscrbr_City'</span>,</span>
<span id="cb130-439"><a href="#cb130-439" aria-hidden="true" tabindex="-1"></a>           <span class="at">state =</span> <span class="st">'Prscrbr_State_Abrvtn'</span>,</span>
<span id="cb130-440"><a href="#cb130-440" aria-hidden="true" tabindex="-1"></a>           <span class="at">postalcode =</span> <span class="st">'Prscrbr_zip5'</span>)</span>
<span id="cb130-441"><a href="#cb130-441" aria-hidden="true" tabindex="-1"></a>      , <span class="fu">list</span>(<span class="at">method =</span> <span class="st">'arcgis'</span></span>
<span id="cb130-442"><a href="#cb130-442" aria-hidden="true" tabindex="-1"></a>           , <span class="at">address =</span> <span class="st">'address'</span>)</span>
<span id="cb130-443"><a href="#cb130-443" aria-hidden="true" tabindex="-1"></a>      , <span class="fu">list</span>(<span class="at">method =</span> <span class="st">'osm'</span>,</span>
<span id="cb130-444"><a href="#cb130-444" aria-hidden="true" tabindex="-1"></a>           <span class="at">street =</span> <span class="st">'Prscrbr_St1'</span>,</span>
<span id="cb130-445"><a href="#cb130-445" aria-hidden="true" tabindex="-1"></a>           <span class="at">city =</span> <span class="st">'Prscrbr_City'</span>,</span>
<span id="cb130-446"><a href="#cb130-446" aria-hidden="true" tabindex="-1"></a>           <span class="at">state =</span> <span class="st">'Prscrbr_State_Abrvtn'</span>,</span>
<span id="cb130-447"><a href="#cb130-447" aria-hidden="true" tabindex="-1"></a>           <span class="at">postalcode =</span> <span class="st">'Prscrbr_zip5'</span>)</span>
<span id="cb130-448"><a href="#cb130-448" aria-hidden="true" tabindex="-1"></a>      , <span class="fu">list</span>(<span class="at">method =</span> <span class="st">'iq'</span></span>
<span id="cb130-449"><a href="#cb130-449" aria-hidden="true" tabindex="-1"></a>           , <span class="at">street =</span> <span class="st">'Prscrbr_St1'</span></span>
<span id="cb130-450"><a href="#cb130-450" aria-hidden="true" tabindex="-1"></a>           , <span class="at">city =</span> <span class="st">'Prscrbr_City'</span></span>
<span id="cb130-451"><a href="#cb130-451" aria-hidden="true" tabindex="-1"></a>           , <span class="at">state =</span> <span class="st">'Prscrbr_State_Abrvtn'</span></span>
<span id="cb130-452"><a href="#cb130-452" aria-hidden="true" tabindex="-1"></a>           , <span class="at">postalcode =</span> <span class="st">'Prscrbr_zip5'</span></span>
<span id="cb130-453"><a href="#cb130-453" aria-hidden="true" tabindex="-1"></a>           , <span class="at">custom_query =</span> <span class="fu">list</span>(<span class="at">limit =</span> <span class="dv">1</span>)</span>
<span id="cb130-454"><a href="#cb130-454" aria-hidden="true" tabindex="-1"></a>           )</span>
<span id="cb130-455"><a href="#cb130-455" aria-hidden="true" tabindex="-1"></a>      , <span class="fu">list</span>(<span class="at">method =</span> <span class="st">'tomtom'</span></span>
<span id="cb130-456"><a href="#cb130-456" aria-hidden="true" tabindex="-1"></a>           , <span class="at">address =</span> <span class="st">'address'</span></span>
<span id="cb130-457"><a href="#cb130-457" aria-hidden="true" tabindex="-1"></a>           , <span class="at">custom_query =</span> <span class="fu">list</span>(<span class="at">limit =</span> <span class="dv">5</span>)</span>
<span id="cb130-458"><a href="#cb130-458" aria-hidden="true" tabindex="-1"></a>           )</span>
<span id="cb130-459"><a href="#cb130-459" aria-hidden="true" tabindex="-1"></a>      <span class="co"># , list(method = 'mapbox'</span></span>
<span id="cb130-460"><a href="#cb130-460" aria-hidden="true" tabindex="-1"></a>      <span class="co">#      , address = 'address'</span></span>
<span id="cb130-461"><a href="#cb130-461" aria-hidden="true" tabindex="-1"></a>      <span class="co">#      , custom_query = list(limit = 10)</span></span>
<span id="cb130-462"><a href="#cb130-462" aria-hidden="true" tabindex="-1"></a>      <span class="co">#      )</span></span>
<span id="cb130-463"><a href="#cb130-463" aria-hidden="true" tabindex="-1"></a>      , <span class="fu">list</span>(<span class="at">method =</span> <span class="st">'geoapify'</span></span>
<span id="cb130-464"><a href="#cb130-464" aria-hidden="true" tabindex="-1"></a>           , <span class="at">street =</span> <span class="st">'Prscrbr_St1'</span></span>
<span id="cb130-465"><a href="#cb130-465" aria-hidden="true" tabindex="-1"></a>           , <span class="at">city =</span> <span class="st">'Prscrbr_City'</span></span>
<span id="cb130-466"><a href="#cb130-466" aria-hidden="true" tabindex="-1"></a>           , <span class="at">state =</span> <span class="st">'Prscrbr_State_Abrvtn'</span></span>
<span id="cb130-467"><a href="#cb130-467" aria-hidden="true" tabindex="-1"></a>           , <span class="at">postalcode =</span> <span class="st">'Prscrbr_zip5'</span></span>
<span id="cb130-468"><a href="#cb130-468" aria-hidden="true" tabindex="-1"></a>           , <span class="at">custom_query =</span> <span class="fu">list</span>(<span class="at">limit =</span> <span class="dv">5</span>)</span>
<span id="cb130-469"><a href="#cb130-469" aria-hidden="true" tabindex="-1"></a>           )</span>
<span id="cb130-470"><a href="#cb130-470" aria-hidden="true" tabindex="-1"></a>      <span class="co"># , list(method = 'opencage'</span></span>
<span id="cb130-471"><a href="#cb130-471" aria-hidden="true" tabindex="-1"></a>      <span class="co">#      , address = 'address'</span></span>
<span id="cb130-472"><a href="#cb130-472" aria-hidden="true" tabindex="-1"></a>      <span class="co">#      , custom_query = list(limit = 1)</span></span>
<span id="cb130-473"><a href="#cb130-473" aria-hidden="true" tabindex="-1"></a>      <span class="co">#      )</span></span>
<span id="cb130-474"><a href="#cb130-474" aria-hidden="true" tabindex="-1"></a>      , <span class="fu">list</span>(<span class="at">method =</span> <span class="st">'geocodio'</span></span>
<span id="cb130-475"><a href="#cb130-475" aria-hidden="true" tabindex="-1"></a>           , <span class="at">street =</span> <span class="st">'Prscrbr_St1'</span></span>
<span id="cb130-476"><a href="#cb130-476" aria-hidden="true" tabindex="-1"></a>           , <span class="at">city =</span> <span class="st">'Prscrbr_City'</span></span>
<span id="cb130-477"><a href="#cb130-477" aria-hidden="true" tabindex="-1"></a>           , <span class="at">state =</span> <span class="st">'Prscrbr_State_Abrvtn'</span></span>
<span id="cb130-478"><a href="#cb130-478" aria-hidden="true" tabindex="-1"></a>           , <span class="at">postalcode =</span> <span class="st">'Prscrbr_zip5'</span></span>
<span id="cb130-479"><a href="#cb130-479" aria-hidden="true" tabindex="-1"></a>           , <span class="at">custom_query =</span> <span class="fu">list</span>(<span class="at">limit =</span> <span class="dv">5</span>)</span>
<span id="cb130-480"><a href="#cb130-480" aria-hidden="true" tabindex="-1"></a>           )</span>
<span id="cb130-481"><a href="#cb130-481" aria-hidden="true" tabindex="-1"></a>      <span class="co"># , list(method = 'here'</span></span>
<span id="cb130-482"><a href="#cb130-482" aria-hidden="true" tabindex="-1"></a>      <span class="co">#      , address = 'address'</span></span>
<span id="cb130-483"><a href="#cb130-483" aria-hidden="true" tabindex="-1"></a>      <span class="co">#      , custom_query = list(limit = 5)</span></span>
<span id="cb130-484"><a href="#cb130-484" aria-hidden="true" tabindex="-1"></a>      <span class="co">#      )</span></span>
<span id="cb130-485"><a href="#cb130-485" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb130-486"><a href="#cb130-486" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb130-487"><a href="#cb130-487" aria-hidden="true" tabindex="-1"></a>queries</span>
<span id="cb130-488"><a href="#cb130-488" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-489"><a href="#cb130-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-492"><a href="#cb130-492" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-493"><a href="#cb130-493" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: test_queries</span></span>
<span id="cb130-494"><a href="#cb130-494" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: FALSE</span></span>
<span id="cb130-495"><a href="#cb130-495" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: FALSE</span></span>
<span id="cb130-496"><a href="#cb130-496" aria-hidden="true" tabindex="-1"></a><span class="co"># test queries</span></span>
<span id="cb130-497"><a href="#cb130-497" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (query <span class="cf">in</span> queries<span class="sc">$</span>service) {</span>
<span id="cb130-498"><a href="#cb130-498" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"query "</span>, queries[query <span class="sc">==</span> queries<span class="sc">$</span>service,]<span class="sc">$</span>i, <span class="st">": "</span>, query))</span>
<span id="cb130-499"><a href="#cb130-499" aria-hidden="true" tabindex="-1"></a>  queries[queries[query <span class="sc">==</span> queries<span class="sc">$</span>service,]<span class="sc">$</span>i<span class="sc">:</span><span class="fu">nrow</span>(queries),]<span class="sc">$</span>queries <span class="sc">|&gt;</span></span>
<span id="cb130-500"><a href="#cb130-500" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rmNullObs</span>() <span class="sc">|&gt;</span></span>
<span id="cb130-501"><a href="#cb130-501" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>()</span>
<span id="cb130-502"><a href="#cb130-502" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb130-503"><a href="#cb130-503" aria-hidden="true" tabindex="-1"></a><span class="co"># # test queries as they will be in re-geocoding blocks</span></span>
<span id="cb130-504"><a href="#cb130-504" aria-hidden="true" tabindex="-1"></a><span class="co"># for (query in unique(addresses[addresses$miss_state2 != 0,]$query2)) {</span></span>
<span id="cb130-505"><a href="#cb130-505" aria-hidden="true" tabindex="-1"></a><span class="co">#   print(paste0("query ", queries[query == queries$service,]$i, ": ", query))</span></span>
<span id="cb130-506"><a href="#cb130-506" aria-hidden="true" tabindex="-1"></a><span class="co">#   queries[queries[query == queries$service,]$i+1:nrow(queries),]$queries |&gt;</span></span>
<span id="cb130-507"><a href="#cb130-507" aria-hidden="true" tabindex="-1"></a><span class="co">#     rmNullObs() |&gt;</span></span>
<span id="cb130-508"><a href="#cb130-508" aria-hidden="true" tabindex="-1"></a><span class="co">#     print()</span></span>
<span id="cb130-509"><a href="#cb130-509" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb130-510"><a href="#cb130-510" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-511"><a href="#cb130-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-514"><a href="#cb130-514" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-515"><a href="#cb130-515" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: test_services</span></span>
<span id="cb130-516"><a href="#cb130-516" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: FALSE</span></span>
<span id="cb130-517"><a href="#cb130-517" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: FALSE</span></span>
<span id="cb130-518"><a href="#cb130-518" aria-hidden="true" tabindex="-1"></a>i <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb130-519"><a href="#cb130-519" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (query <span class="cf">in</span> queries<span class="sc">$</span>service) {</span>
<span id="cb130-520"><a href="#cb130-520" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"query "</span>, queries[query <span class="sc">==</span> queries<span class="sc">$</span>service,]<span class="sc">$</span>i, <span class="st">": "</span>, query))</span>
<span id="cb130-521"><a href="#cb130-521" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geocode_combine</span>(</span>
<span id="cb130-522"><a href="#cb130-522" aria-hidden="true" tabindex="-1"></a>    addresses[i,],</span>
<span id="cb130-523"><a href="#cb130-523" aria-hidden="true" tabindex="-1"></a>    <span class="at">queries =</span> queries[queries[query <span class="sc">==</span> queries<span class="sc">$</span>service,]<span class="sc">$</span>i<span class="sc">:</span><span class="fu">nrow</span>(queries),]<span class="sc">$</span>queries <span class="sc">|&gt;</span></span>
<span id="cb130-524"><a href="#cb130-524" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rmNullObs</span>(),</span>
<span id="cb130-525"><a href="#cb130-525" aria-hidden="true" tabindex="-1"></a>    <span class="at">cascade =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-526"><a href="#cb130-526" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>()</span>
<span id="cb130-527"><a href="#cb130-527" aria-hidden="true" tabindex="-1"></a>  i <span class="ot">=</span> i<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb130-528"><a href="#cb130-528" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb130-529"><a href="#cb130-529" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-530"><a href="#cb130-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-531"><a href="#cb130-531" aria-hidden="true" tabindex="-1"></a>The following code geocodes entries individually so as not to exceed limits for each service.  NB geocoding API keys be generated and stored as an environmental variable (i.e. edit .Renviron, and load) for services other than US Census, OSM &amp; ArcGIS.</span>
<span id="cb130-532"><a href="#cb130-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-535"><a href="#cb130-535" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-536"><a href="#cb130-536" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: geocoding_1_by_1</span></span>
<span id="cb130-537"><a href="#cb130-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-538"><a href="#cb130-538" aria-hidden="true" tabindex="-1"></a>addresses_geo <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb130-539"><a href="#cb130-539" aria-hidden="true" tabindex="-1"></a>top_i <span class="ot">&lt;-</span> <span class="fu">nrow</span>(addresses)</span>
<span id="cb130-540"><a href="#cb130-540" aria-hidden="true" tabindex="-1"></a>top_j <span class="ot">&lt;-</span> <span class="fu">nrow</span>(queries)</span>
<span id="cb130-541"><a href="#cb130-541" aria-hidden="true" tabindex="-1"></a><span class="co"># top_i &lt;- 100</span></span>
<span id="cb130-542"><a href="#cb130-542" aria-hidden="true" tabindex="-1"></a><span class="co"># top_j &lt;- 3</span></span>
<span id="cb130-543"><a href="#cb130-543" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb130-544"><a href="#cb130-544" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>top_i) {</span>
<span id="cb130-545"><a href="#cb130-545" aria-hidden="true" tabindex="-1"></a>  addresses2 <span class="ot">&lt;-</span> addresses[i,] <span class="sc">|&gt;</span></span>
<span id="cb130-546"><a href="#cb130-546" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">fips_geo =</span> <span class="cn">NA</span>)</span>
<span id="cb130-547"><a href="#cb130-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-548"><a href="#cb130-548" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>top_j) {</span>
<span id="cb130-549"><a href="#cb130-549" aria-hidden="true" tabindex="-1"></a>    service <span class="ot">&lt;-</span> queries[j,]<span class="sc">$</span>service</span>
<span id="cb130-550"><a href="#cb130-550" aria-hidden="true" tabindex="-1"></a>    addresses2 <span class="ot">&lt;-</span> <span class="fu">geocode</span>(</span>
<span id="cb130-551"><a href="#cb130-551" aria-hidden="true" tabindex="-1"></a>      addresses2,</span>
<span id="cb130-552"><a href="#cb130-552" aria-hidden="true" tabindex="-1"></a>      <span class="at">address =</span> address,</span>
<span id="cb130-553"><a href="#cb130-553" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> service,</span>
<span id="cb130-554"><a href="#cb130-554" aria-hidden="true" tabindex="-1"></a>      <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb130-555"><a href="#cb130-555" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb130-556"><a href="#cb130-556" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb130-557"><a href="#cb130-557" aria-hidden="true" tabindex="-1"></a>      <span class="at">fips2 =</span> <span class="fu">coords_to_fips</span>(<span class="at">x =</span> long, <span class="at">y =</span> lat),</span>
<span id="cb130-558"><a href="#cb130-558" aria-hidden="true" tabindex="-1"></a>      <span class="at">miss_state2 =</span> <span class="fu">if_else</span>(</span>
<span id="cb130-559"><a href="#cb130-559" aria-hidden="true" tabindex="-1"></a>        Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="fu">fips_abbr</span>(fips2),</span>
<span id="cb130-560"><a href="#cb130-560" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span>, <span class="dv">1</span>, <span class="at">missing =</span> <span class="dv">2</span>),</span>
<span id="cb130-561"><a href="#cb130-561" aria-hidden="true" tabindex="-1"></a>      <span class="at">fips_geo =</span> <span class="fu">if_else</span>(</span>
<span id="cb130-562"><a href="#cb130-562" aria-hidden="true" tabindex="-1"></a>        miss_state2 <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb130-563"><a href="#cb130-563" aria-hidden="true" tabindex="-1"></a>        fips2, fips_geo</span>
<span id="cb130-564"><a href="#cb130-564" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb130-565"><a href="#cb130-565" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb130-566"><a href="#cb130-566" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(addresses2)[<span class="fu">names</span>(addresses2) <span class="sc">==</span> <span class="st">"lat"</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"lat_"</span>, service)</span>
<span id="cb130-567"><a href="#cb130-567" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(addresses2)[<span class="fu">names</span>(addresses2) <span class="sc">==</span> <span class="st">"long"</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"long_"</span>, service)</span>
<span id="cb130-568"><a href="#cb130-568" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(addresses2)[<span class="fu">names</span>(addresses2) <span class="sc">==</span> <span class="st">"fips2"</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"fips_"</span>, service)</span>
<span id="cb130-569"><a href="#cb130-569" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(addresses2)[<span class="fu">names</span>(addresses2) <span class="sc">==</span> <span class="st">"miss_state2"</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"miss_state_"</span>, service)</span>
<span id="cb130-570"><a href="#cb130-570" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb130-571"><a href="#cb130-571" aria-hidden="true" tabindex="-1"></a>  addresses_geo <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb130-572"><a href="#cb130-572" aria-hidden="true" tabindex="-1"></a>    addresses_geo,</span>
<span id="cb130-573"><a href="#cb130-573" aria-hidden="true" tabindex="-1"></a>    addresses2)</span>
<span id="cb130-574"><a href="#cb130-574" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb130-575"><a href="#cb130-575" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-576"><a href="#cb130-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-577"><a href="#cb130-577" aria-hidden="true" tabindex="-1"></a>Diagnostics:</span>
<span id="cb130-578"><a href="#cb130-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-581"><a href="#cb130-581" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-582"><a href="#cb130-582" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: geocoding_diagnostics</span></span>
<span id="cb130-583"><a href="#cb130-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-584"><a href="#cb130-584" aria-hidden="true" tabindex="-1"></a>addresses_geo <span class="sc">|&gt;</span></span>
<span id="cb130-585"><a href="#cb130-585" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(group) <span class="sc">|&gt;</span></span>
<span id="cb130-586"><a href="#cb130-586" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb130-587"><a href="#cb130-587" aria-hidden="true" tabindex="-1"></a>    <span class="at">Missing_fips =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(fips_geo)),</span>
<span id="cb130-588"><a href="#cb130-588" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> <span class="fu">n</span>()</span>
<span id="cb130-589"><a href="#cb130-589" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb130-590"><a href="#cb130-590" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(N)) <span class="sc">|&gt;</span></span>
<span id="cb130-591"><a href="#cb130-591" aria-hidden="true" tabindex="-1"></a>  <span class="fu">adorn_totals</span>()</span>
<span id="cb130-592"><a href="#cb130-592" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-593"><a href="#cb130-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-594"><a href="#cb130-594" aria-hidden="true" tabindex="-1"></a>We can see that about half of the addresses have been successfully resolved.</span>
<span id="cb130-595"><a href="#cb130-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-596"><a href="#cb130-596" aria-hidden="true" tabindex="-1"></a><span class="fu">### Remaining Addresses</span></span>
<span id="cb130-597"><a href="#cb130-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-598"><a href="#cb130-598" aria-hidden="true" tabindex="-1"></a>Examine the addresses which were not matched by USGS, zipcode, or geocoding:</span>
<span id="cb130-599"><a href="#cb130-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-602"><a href="#cb130-602" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-603"><a href="#cb130-603" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: report_addresses</span></span>
<span id="cb130-604"><a href="#cb130-604" aria-hidden="true" tabindex="-1"></a>addresses_geo <span class="sc">|&gt;</span></span>
<span id="cb130-605"><a href="#cb130-605" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(query0 <span class="sc">==</span> <span class="st">"geo"</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(fips_geo)) <span class="sc">|&gt;</span></span>
<span id="cb130-606"><a href="#cb130-606" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(address)</span>
<span id="cb130-607"><a href="#cb130-607" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-608"><a href="#cb130-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-609"><a href="#cb130-609" aria-hidden="true" tabindex="-1"></a><span class="fu"># Compiling final datasets:</span></span>
<span id="cb130-610"><a href="#cb130-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-613"><a href="#cb130-613" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-614"><a href="#cb130-614" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: join_data_fips</span></span>
<span id="cb130-615"><a href="#cb130-615" aria-hidden="true" tabindex="-1"></a>data_fips <span class="ot">&lt;-</span> <span class="fu">left_join</span>(data_fips,               <span class="co"># L dataset</span></span>
<span id="cb130-616"><a href="#cb130-616" aria-hidden="true" tabindex="-1"></a>  addresses_geo <span class="sc">|&gt;</span> <span class="fu">select</span>(address, fips_geo),   <span class="co"># R dataset</span></span>
<span id="cb130-617"><a href="#cb130-617" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">join_by</span>(address <span class="sc">==</span> address),</span>
<span id="cb130-618"><a href="#cb130-618" aria-hidden="true" tabindex="-1"></a>  <span class="at">relationship =</span> <span class="st">"many-to-one"</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-619"><a href="#cb130-619" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fold geocoded fips codes into main fips var</span></span>
<span id="cb130-620"><a href="#cb130-620" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fips =</span> <span class="fu">if_else</span>(</span>
<span id="cb130-621"><a href="#cb130-621" aria-hidden="true" tabindex="-1"></a>    query0 <span class="sc">==</span> <span class="st">"geo"</span>,</span>
<span id="cb130-622"><a href="#cb130-622" aria-hidden="true" tabindex="-1"></a>    fips_geo, </span>
<span id="cb130-623"><a href="#cb130-623" aria-hidden="true" tabindex="-1"></a>    fips))</span>
<span id="cb130-624"><a href="#cb130-624" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-625"><a href="#cb130-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-626"><a href="#cb130-626" aria-hidden="true" tabindex="-1"></a>Save datasets:</span>
<span id="cb130-627"><a href="#cb130-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-628"><a href="#cb130-628" aria-hidden="true" tabindex="-1"></a><span class="in">```{r save}</span></span>
<span id="cb130-629"><a href="#cb130-629" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(data_fips,</span>
<span id="cb130-630"><a href="#cb130-630" aria-hidden="true" tabindex="-1"></a>     <span class="at">file =</span> <span class="st">"dataset/data_fips.RData"</span>,</span>
<span id="cb130-631"><a href="#cb130-631" aria-hidden="true" tabindex="-1"></a>     <span class="at">compress =</span> <span class="cn">TRUE</span>,</span>
<span id="cb130-632"><a href="#cb130-632" aria-hidden="true" tabindex="-1"></a>     <span class="at">compression_level =</span> <span class="dv">9</span>)</span>
<span id="cb130-633"><a href="#cb130-633" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(addresses_geo,</span>
<span id="cb130-634"><a href="#cb130-634" aria-hidden="true" tabindex="-1"></a>     <span class="at">file =</span> <span class="st">"dataset/addresses_geo.RData"</span>,</span>
<span id="cb130-635"><a href="#cb130-635" aria-hidden="true" tabindex="-1"></a>     <span class="at">compress =</span> <span class="cn">TRUE</span>,</span>
<span id="cb130-636"><a href="#cb130-636" aria-hidden="true" tabindex="-1"></a>     <span class="at">compression_level =</span> <span class="dv">9</span>)</span>
<span id="cb130-637"><a href="#cb130-637" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-638"><a href="#cb130-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-639"><a href="#cb130-639" aria-hidden="true" tabindex="-1"></a><span class="fu"># Other Thoughts</span></span>
<span id="cb130-640"><a href="#cb130-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-641"><a href="#cb130-641" aria-hidden="true" tabindex="-1"></a>Indication for OUD use (vs pain or EtOH use disorder) is a potential source of error when classifying prescriptions in the <span class="in">`tx`</span> variable.  Consider future methods to potentially validate OUD vs pain treatment designations (as time allows):</span>
<span id="cb130-642"><a href="#cb130-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-643"><a href="#cb130-643" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Classify prescriptions as OUD vs pain vs EtOH use disorder based on KNN of names of other drugs prescribed by the provider</span>
<span id="cb130-644"><a href="#cb130-644" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Query <span class="co">[</span><span class="ot">FDA NDC DB</span><span class="co">](https://open.fda.gov/apis/drug/ndc/how-to-use-the-endpoint/)</span> for NPIs associated with the values of <span class="in">`Brnd_Name`</span> and <span class="in">`Gnrc_Name`</span> which were matched above, then search those NDCs for the indication for use on DailyMed</span>
<span id="cb130-645"><a href="#cb130-645" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Check DEA X waver for prescriber's NPI</span>
<span id="cb130-646"><a href="#cb130-646" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Check prescriber's buprenorphine panel limit vs count of buprenorphine prescribed</span>
<span id="cb130-647"><a href="#cb130-647" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Check prescriber's place of work in NPI DB</span>
<span id="cb130-648"><a href="#cb130-648" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>interrogate/validate CMS's method for translating a drug's NDC into a drug's brand and generic names</span>
<span id="cb130-649"><a href="#cb130-649" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>recalculate the rural-urban classification for each year using the <span class="co">[</span><span class="ot">census estimates</span><span class="co">](https://www.census.gov/programs-surveys/popest/data/data-sets.html)</span></span>
<span id="cb130-650"><a href="#cb130-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-651"><a href="#cb130-651" aria-hidden="true" tabindex="-1"></a>Translation from NDC to a drug's brand/generic names likely simplifies many analyses, but could be a significant source of bias for our analysis.</span>
<span id="cb130-652"><a href="#cb130-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-653"><a href="#cb130-653" aria-hidden="true" tabindex="-1"></a><span class="fu">## Alternate Approaches to Geocoding, Reverse Geocoding &amp; NCHSURC classification</span></span>
<span id="cb130-654"><a href="#cb130-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-655"><a href="#cb130-655" aria-hidden="true" tabindex="-1"></a>Alternate geocoding:</span>
<span id="cb130-656"><a href="#cb130-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-657"><a href="#cb130-657" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>The <span class="in">`geocode()`</span> function from the <span class="in">`ggmap`</span> package to find the coordinates for each city/state combination.  The function will return a dataframe with the coordinates for each city/state combination, and will also return a status code indicating whether the coordinates were found successfully.  We will use the status code to filter out any entries for which the coordinates were not found.  This method requires access to the google API.</span>
<span id="cb130-658"><a href="#cb130-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-659"><a href="#cb130-659" aria-hidden="true" tabindex="-1"></a>Alternate reverse-geocoding:</span>
<span id="cb130-660"><a href="#cb130-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-661"><a href="#cb130-661" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>The <span class="in">`fips()`</span> function from the <span class="in">`USAboundaries`</span> package to convert the coordinates to FIPS code.  This function uses the <span class="in">`sf`</span> package to find the FIPS code for the county in which the coordinates are located.  This method is the most straightforward, but it is also the slowest.</span>
<span id="cb130-662"><a href="#cb130-662" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>The <span class="in">`fips()`</span> function from the <span class="in">`tigris`</span> package to convert the coordinates to FIPS code.  This function uses the <span class="in">`sf`</span> package to find the FIPS code for the county in which the coordinates are located.  This method is faster than the <span class="in">`USAboundaries`</span> method, but it is still relatively slow.</span>
<span id="cb130-663"><a href="#cb130-663" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>The <span class="in">`fips()`</span> function from the <span class="in">`MazamaSpatialUtils`</span> package to convert the coordinates to FIPS code.  This function uses a lookup table to find the FIPS code for the county in which the coordinates are located.  This method is the fastest, but it is also the least accurate.  The lookup table is based on the 2010 census, so it will not include any counties that were created after 2010.  This method will also not work for any coordinates that are outside of the US.</span>
<span id="cb130-664"><a href="#cb130-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-665"><a href="#cb130-665" aria-hidden="true" tabindex="-1"></a>Rural-urban classification:</span>
<span id="cb130-666"><a href="#cb130-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-667"><a href="#cb130-667" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Lookup rural-urban clssification: For this step we can used CDC's <span class="co">[</span><span class="ot">2013 Urban-Rural Classification Scheme for Counties</span><span class="co">](https://www.cdc.gov/nchs/data_access/urban_rural.htm)</span>; specifically the <span class="co">[</span><span class="ot">NCHSurbruralcodes Spreadsheet</span><span class="co">](https://www.cdc.gov/nchs/data/data_acces_files/NCHSURCodes2013.xlsx)</span> which contains the FIPS codes and rural-urban classifications for each county in the US.  The data can be plotted according to FIPS code using <span class="in">`ggplot2`</span> or <span class="in">`MazamaSpatialPlots`</span> packages.</span>
<span id="cb130-668"><a href="#cb130-668" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Alternatively the classification could be manually recalculated from census data for each year.</span>
<span id="cb130-669"><a href="#cb130-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-670"><a href="#cb130-670" aria-hidden="true" tabindex="-1"></a><span class="fu"># Session Info</span></span>
<span id="cb130-671"><a href="#cb130-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-674"><a href="#cb130-674" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-675"><a href="#cb130-675" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: session_info</span></span>
<span id="cb130-676"><a href="#cb130-676" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb130-677"><a href="#cb130-677" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-678"><a href="#cb130-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-681"><a href="#cb130-681" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-682"><a href="#cb130-682" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: geocode_here</span></span>
<span id="cb130-683"><a href="#cb130-683" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: FALSE</span></span>
<span id="cb130-684"><a href="#cb130-684" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: FALSE</span></span>
<span id="cb130-685"><a href="#cb130-685" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb130-686"><a href="#cb130-686" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(addresses_geo)) {</span>
<span id="cb130-687"><a href="#cb130-687" aria-hidden="true" tabindex="-1"></a>  addresses2 <span class="ot">&lt;-</span> addresses_geo[i,]</span>
<span id="cb130-688"><a href="#cb130-688" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb130-689"><a href="#cb130-689" aria-hidden="true" tabindex="-1"></a>  service <span class="ot">&lt;-</span> <span class="st">"here"</span></span>
<span id="cb130-690"><a href="#cb130-690" aria-hidden="true" tabindex="-1"></a>  addresses2 <span class="ot">&lt;-</span> <span class="fu">geocode</span>(</span>
<span id="cb130-691"><a href="#cb130-691" aria-hidden="true" tabindex="-1"></a>    addresses2,</span>
<span id="cb130-692"><a href="#cb130-692" aria-hidden="true" tabindex="-1"></a>    <span class="at">address =</span> address,</span>
<span id="cb130-693"><a href="#cb130-693" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> service,</span>
<span id="cb130-694"><a href="#cb130-694" aria-hidden="true" tabindex="-1"></a>    <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb130-695"><a href="#cb130-695" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb130-696"><a href="#cb130-696" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb130-697"><a href="#cb130-697" aria-hidden="true" tabindex="-1"></a>    <span class="at">fips2 =</span> <span class="fu">coords_to_fips</span>(<span class="at">x =</span> long, <span class="at">y =</span> lat),</span>
<span id="cb130-698"><a href="#cb130-698" aria-hidden="true" tabindex="-1"></a>    <span class="at">miss_state2 =</span> <span class="fu">if_else</span>(</span>
<span id="cb130-699"><a href="#cb130-699" aria-hidden="true" tabindex="-1"></a>      Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="fu">fips_abbr</span>(fips2),</span>
<span id="cb130-700"><a href="#cb130-700" aria-hidden="true" tabindex="-1"></a>      <span class="dv">0</span>, <span class="dv">1</span>, <span class="at">missing =</span> <span class="dv">2</span>),</span>
<span id="cb130-701"><a href="#cb130-701" aria-hidden="true" tabindex="-1"></a>    <span class="at">fips_geo =</span> <span class="fu">if_else</span>(</span>
<span id="cb130-702"><a href="#cb130-702" aria-hidden="true" tabindex="-1"></a>      miss_state2 <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb130-703"><a href="#cb130-703" aria-hidden="true" tabindex="-1"></a>      fips2, fips_geo</span>
<span id="cb130-704"><a href="#cb130-704" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb130-705"><a href="#cb130-705" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb130-706"><a href="#cb130-706" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(addresses2)[<span class="fu">names</span>(addresses2) <span class="sc">==</span> <span class="st">"lat"</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"lat_"</span>, service)</span>
<span id="cb130-707"><a href="#cb130-707" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(addresses2)[<span class="fu">names</span>(addresses2) <span class="sc">==</span> <span class="st">"long"</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"long_"</span>, service)</span>
<span id="cb130-708"><a href="#cb130-708" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(addresses2)[<span class="fu">names</span>(addresses2) <span class="sc">==</span> <span class="st">"fips2"</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"fips_"</span>, service)</span>
<span id="cb130-709"><a href="#cb130-709" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(addresses2)[<span class="fu">names</span>(addresses2) <span class="sc">==</span> <span class="st">"miss_state2"</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"miss_state_"</span>, service)</span>
<span id="cb130-710"><a href="#cb130-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-711"><a href="#cb130-711" aria-hidden="true" tabindex="-1"></a>  addresses_geo <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb130-712"><a href="#cb130-712" aria-hidden="true" tabindex="-1"></a>    addresses_geo,</span>
<span id="cb130-713"><a href="#cb130-713" aria-hidden="true" tabindex="-1"></a>    addresses2)</span>
<span id="cb130-714"><a href="#cb130-714" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb130-715"><a href="#cb130-715" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-716"><a href="#cb130-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-719"><a href="#cb130-719" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-720"><a href="#cb130-720" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: re_geocoding</span></span>
<span id="cb130-721"><a href="#cb130-721" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: FALSE</span></span>
<span id="cb130-722"><a href="#cb130-722" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: FALSE</span></span>
<span id="cb130-723"><a href="#cb130-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-724"><a href="#cb130-724" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>(<span class="fu">nrow</span>(queries))) {        <span class="co"># repeat re-geocoding &amp; diagnostics</span></span>
<span id="cb130-725"><a href="#cb130-725" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (query <span class="cf">in</span> <span class="fu">unique</span>(addresses[addresses<span class="sc">$</span>miss_state2 <span class="sc">!=</span> <span class="dv">0</span>,]<span class="sc">$</span>query2)) {</span>
<span id="cb130-726"><a href="#cb130-726" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.NullOb</span>(queries[queries[query <span class="sc">==</span> queries<span class="sc">$</span>service,]<span class="sc">$</span>i<span class="sc">+</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(queries),]<span class="sc">$</span>queries)){</span>
<span id="cb130-727"><a href="#cb130-727" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb130-728"><a href="#cb130-728" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb130-729"><a href="#cb130-729" aria-hidden="true" tabindex="-1"></a>    addresses <span class="ot">&lt;-</span> <span class="fu">left_join</span>(addresses,   <span class="co"># x dataset</span></span>
<span id="cb130-730"><a href="#cb130-730" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geocode_combine</span>(                  <span class="co"># y dataset</span></span>
<span id="cb130-731"><a href="#cb130-731" aria-hidden="true" tabindex="-1"></a>        addresses <span class="sc">|&gt;</span> <span class="fu">filter</span>(miss_state2 <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">&amp;</span> query2 <span class="sc">==</span> query),</span>
<span id="cb130-732"><a href="#cb130-732" aria-hidden="true" tabindex="-1"></a>        <span class="at">queries =</span></span>
<span id="cb130-733"><a href="#cb130-733" aria-hidden="true" tabindex="-1"></a>          queries[queries[query <span class="sc">==</span> queries<span class="sc">$</span>service,]<span class="sc">$</span>i<span class="sc">+</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(queries),]<span class="sc">$</span>queries <span class="sc">|&gt;</span></span>
<span id="cb130-734"><a href="#cb130-734" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rmNullObs</span>(),</span>
<span id="cb130-735"><a href="#cb130-735" aria-hidden="true" tabindex="-1"></a>        <span class="at">cascade =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-736"><a href="#cb130-736" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(address, lat, long, query),</span>
<span id="cb130-737"><a href="#cb130-737" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">join_by</span>(address <span class="sc">==</span> address),</span>
<span id="cb130-738"><a href="#cb130-738" aria-hidden="true" tabindex="-1"></a>      <span class="at">relationship =</span> <span class="st">"many-to-one"</span>)  <span class="sc">|&gt;</span></span>
<span id="cb130-739"><a href="#cb130-739" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">fips2 =</span></span>
<span id="cb130-740"><a href="#cb130-740" aria-hidden="true" tabindex="-1"></a>      <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(query),            <span class="co"># update fips2 if new query is present</span></span>
<span id="cb130-741"><a href="#cb130-741" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coords_to_fips</span>(<span class="at">x =</span> long, <span class="at">y =</span> lat),<span class="co"># if present calculate new fips2 value</span></span>
<span id="cb130-742"><a href="#cb130-742" aria-hidden="true" tabindex="-1"></a>      fips2)) <span class="sc">|&gt;</span>                        <span class="co"># else keep old value</span></span>
<span id="cb130-743"><a href="#cb130-743" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">miss_state2 =</span>                <span class="co"># update miss_state2</span></span>
<span id="cb130-744"><a href="#cb130-744" aria-hidden="true" tabindex="-1"></a>      <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(query) <span class="sc">&amp;</span> (Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="fu">fips_abbr</span>(fips2)),</span>
<span id="cb130-745"><a href="#cb130-745" aria-hidden="true" tabindex="-1"></a>      <span class="dv">0</span>, <span class="dv">1</span>, <span class="at">missing =</span> miss_state2)) <span class="sc">|&gt;</span></span>
<span id="cb130-746"><a href="#cb130-746" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">query2 =</span>                     <span class="co"># update query2 if there's a new one</span></span>
<span id="cb130-747"><a href="#cb130-747" aria-hidden="true" tabindex="-1"></a>      <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(query),            <span class="co"># check if there's a new query value</span></span>
<span id="cb130-748"><a href="#cb130-748" aria-hidden="true" tabindex="-1"></a>      query, query2)) <span class="sc">|&gt;</span>                <span class="co"># update value; else keep old value</span></span>
<span id="cb130-749"><a href="#cb130-749" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>lat, <span class="sc">-</span>long, <span class="sc">-</span>query)</span>
<span id="cb130-750"><a href="#cb130-750" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb130-751"><a href="#cb130-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-752"><a href="#cb130-752" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Diagnostics:</span></span>
<span id="cb130-753"><a href="#cb130-753" aria-hidden="true" tabindex="-1"></a>  addresses <span class="sc">|&gt;</span></span>
<span id="cb130-754"><a href="#cb130-754" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(query2) <span class="sc">|&gt;</span></span>
<span id="cb130-755"><a href="#cb130-755" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb130-756"><a href="#cb130-756" aria-hidden="true" tabindex="-1"></a>      <span class="at">Missing_fips =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(fips2)),</span>
<span id="cb130-757"><a href="#cb130-757" aria-hidden="true" tabindex="-1"></a>      <span class="at">Correct_State =</span> <span class="fu">sum</span>(miss_state2 <span class="sc">==</span> <span class="dv">0</span>),</span>
<span id="cb130-758"><a href="#cb130-758" aria-hidden="true" tabindex="-1"></a>      <span class="at">N =</span> <span class="fu">n</span>()</span>
<span id="cb130-759"><a href="#cb130-759" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb130-760"><a href="#cb130-760" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(N)) <span class="sc">|&gt;</span></span>
<span id="cb130-761"><a href="#cb130-761" aria-hidden="true" tabindex="-1"></a>    <span class="fu">adorn_totals</span>()</span>
<span id="cb130-762"><a href="#cb130-762" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb130-763"><a href="#cb130-763" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-764"><a href="#cb130-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-767"><a href="#cb130-767" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-768"><a href="#cb130-768" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: unused1</span></span>
<span id="cb130-769"><a href="#cb130-769" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: FALSE</span></span>
<span id="cb130-770"><a href="#cb130-770" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: FALSE</span></span>
<span id="cb130-771"><a href="#cb130-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-772"><a href="#cb130-772" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (query <span class="cf">in</span> <span class="fu">unique</span>(addresses[addresses<span class="sc">$</span>miss_state2 <span class="sc">!=</span> <span class="dv">0</span>,]<span class="sc">$</span>query2)) {</span>
<span id="cb130-773"><a href="#cb130-773" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(query)</span>
<span id="cb130-774"><a href="#cb130-774" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(queries[query <span class="sc">==</span> queries<span class="sc">$</span>service,]<span class="sc">$</span>i<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb130-775"><a href="#cb130-775" aria-hidden="true" tabindex="-1"></a>  queries[queries[query <span class="sc">==</span> queries<span class="sc">$</span>service,]<span class="sc">$</span>i<span class="sc">+</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(queries),]<span class="sc">$</span>queries <span class="sc">|&gt;</span></span>
<span id="cb130-776"><a href="#cb130-776" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rmNullObs</span>() <span class="sc">|&gt;</span></span>
<span id="cb130-777"><a href="#cb130-777" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>()</span>
<span id="cb130-778"><a href="#cb130-778" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb130-779"><a href="#cb130-779" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-780"><a href="#cb130-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-783"><a href="#cb130-783" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-784"><a href="#cb130-784" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: unused2</span></span>
<span id="cb130-785"><a href="#cb130-785" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: FALSE</span></span>
<span id="cb130-786"><a href="#cb130-786" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: FALSE</span></span>
<span id="cb130-787"><a href="#cb130-787" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (query <span class="cf">in</span> <span class="fu">unique</span>(addresses[addresses<span class="sc">$</span>miss_state2 <span class="sc">!=</span> <span class="dv">0</span>,]<span class="sc">$</span>query2)) {</span>
<span id="cb130-788"><a href="#cb130-788" aria-hidden="true" tabindex="-1"></a> <span class="fu">print</span>(query)</span>
<span id="cb130-789"><a href="#cb130-789" aria-hidden="true" tabindex="-1"></a> <span class="fu">print</span>(queries[query <span class="sc">==</span> queries<span class="sc">$</span>service,]<span class="sc">$</span>i<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb130-790"><a href="#cb130-790" aria-hidden="true" tabindex="-1"></a> <span class="co"># addresses |&gt; filter(miss_state2 != 0 &amp; query2 == query)</span></span>
<span id="cb130-791"><a href="#cb130-791" aria-hidden="true" tabindex="-1"></a> <span class="fu">print</span>(queries[queries[query <span class="sc">==</span> queries<span class="sc">$</span>service,]<span class="sc">$</span>i<span class="sc">+</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(queries),]<span class="sc">$</span>queries)</span>
<span id="cb130-792"><a href="#cb130-792" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb130-793"><a href="#cb130-793" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-794"><a href="#cb130-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-797"><a href="#cb130-797" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-798"><a href="#cb130-798" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: old_regeocode</span></span>
<span id="cb130-799"><a href="#cb130-799" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: FALSE</span></span>
<span id="cb130-800"><a href="#cb130-800" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: FALSE</span></span>
<span id="cb130-801"><a href="#cb130-801" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (query <span class="cf">in</span> <span class="fu">unique</span>(addresses[addresses<span class="sc">$</span>miss_state2 <span class="sc">!=</span> <span class="dv">0</span>,]<span class="sc">$</span>query2)) {</span>
<span id="cb130-802"><a href="#cb130-802" aria-hidden="true" tabindex="-1"></a>  addresses <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb130-803"><a href="#cb130-803" aria-hidden="true" tabindex="-1"></a>    addresses,                                                                        </span>
<span id="cb130-804"><a href="#cb130-804" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geocode_combine</span>(                                                                  </span>
<span id="cb130-805"><a href="#cb130-805" aria-hidden="true" tabindex="-1"></a>      addresses <span class="sc">|&gt;</span>                                                                    </span>
<span id="cb130-806"><a href="#cb130-806" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(miss_state2 <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">&amp;</span> query2 <span class="sc">==</span> query),                                   </span>
<span id="cb130-807"><a href="#cb130-807" aria-hidden="true" tabindex="-1"></a>      <span class="at">queries =</span> queries[queries[query <span class="sc">==</span> queries<span class="sc">$</span>service,]<span class="sc">$</span>i<span class="sc">:</span><span class="fu">nrow</span>(queries),]<span class="sc">$</span>queries, </span>
<span id="cb130-808"><a href="#cb130-808" aria-hidden="true" tabindex="-1"></a>      <span class="at">cascade =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span>                                                              </span>
<span id="cb130-809"><a href="#cb130-809" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(address, lat, long, query),                                              </span>
<span id="cb130-810"><a href="#cb130-810" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">join_by</span>(address <span class="sc">==</span> address),</span>
<span id="cb130-811"><a href="#cb130-811" aria-hidden="true" tabindex="-1"></a>    <span class="at">relationship =</span> <span class="st">"many-to-one"</span>)  <span class="sc">|&gt;</span></span>
<span id="cb130-812"><a href="#cb130-812" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Diagnostics: fips, state, and check if the state is correct</span></span>
<span id="cb130-813"><a href="#cb130-813" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fips2 =</span> <span class="fu">coords_to_fips</span>(<span class="at">x =</span> long, <span class="at">y =</span> lat)) <span class="sc">|&gt;</span></span>
<span id="cb130-814"><a href="#cb130-814" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">miss_state2 =</span> <span class="fu">if_else</span>(</span>
<span id="cb130-815"><a href="#cb130-815" aria-hidden="true" tabindex="-1"></a>    Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="fu">fips_abbr</span>(fips2),</span>
<span id="cb130-816"><a href="#cb130-816" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">1</span>, <span class="at">missing =</span> miss_state2)) <span class="sc">|&gt;</span></span>
<span id="cb130-817"><a href="#cb130-817" aria-hidden="true" tabindex="-1"></a>  <span class="do">## rename/remove variables for next round of geocoding</span></span>
<span id="cb130-818"><a href="#cb130-818" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">query2 =</span> <span class="fu">if_else</span>(</span>
<span id="cb130-819"><a href="#cb130-819" aria-hidden="true" tabindex="-1"></a>    miss_state2 <span class="sc">==</span> <span class="dv">0</span>, </span>
<span id="cb130-820"><a href="#cb130-820" aria-hidden="true" tabindex="-1"></a>    query, query2, <span class="at">missing =</span> query2)) <span class="sc">|&gt;</span></span>
<span id="cb130-821"><a href="#cb130-821" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>lat, <span class="sc">-</span>long, <span class="sc">-</span>query)}</span>
<span id="cb130-822"><a href="#cb130-822" aria-hidden="true" tabindex="-1"></a><span class="co"># cleanup</span></span>
<span id="cb130-823"><a href="#cb130-823" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(query)</span>
<span id="cb130-824"><a href="#cb130-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-825"><a href="#cb130-825" aria-hidden="true" tabindex="-1"></a><span class="co"># Diagnostics:</span></span>
<span id="cb130-826"><a href="#cb130-826" aria-hidden="true" tabindex="-1"></a>addresses <span class="sc">|&gt;</span></span>
<span id="cb130-827"><a href="#cb130-827" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(query2) <span class="sc">|&gt;</span></span>
<span id="cb130-828"><a href="#cb130-828" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb130-829"><a href="#cb130-829" aria-hidden="true" tabindex="-1"></a>    <span class="at">Missing_fips =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(fips2)),</span>
<span id="cb130-830"><a href="#cb130-830" aria-hidden="true" tabindex="-1"></a>    <span class="at">Correct_State =</span> <span class="fu">sum</span>(miss_state2 <span class="sc">==</span> <span class="dv">0</span>),</span>
<span id="cb130-831"><a href="#cb130-831" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> <span class="fu">n</span>()</span>
<span id="cb130-832"><a href="#cb130-832" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb130-833"><a href="#cb130-833" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(N)) <span class="sc">|&gt;</span></span>
<span id="cb130-834"><a href="#cb130-834" aria-hidden="true" tabindex="-1"></a>  <span class="fu">adorn_totals</span>()</span>
<span id="cb130-835"><a href="#cb130-835" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-836"><a href="#cb130-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-839"><a href="#cb130-839" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-840"><a href="#cb130-840" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: manual_search</span></span>
<span id="cb130-841"><a href="#cb130-841" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: FALSE</span></span>
<span id="cb130-842"><a href="#cb130-842" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: FALSE</span></span>
<span id="cb130-843"><a href="#cb130-843" aria-hidden="true" tabindex="-1"></a><span class="co"># geo6 &lt;- geo5 |&gt;                                              # x dataset</span></span>
<span id="cb130-844"><a href="#cb130-844" aria-hidden="true" tabindex="-1"></a><span class="co">#   left_join(</span></span>
<span id="cb130-845"><a href="#cb130-845" aria-hidden="true" tabindex="-1"></a><span class="co">#     data.frame(</span></span>
<span id="cb130-846"><a href="#cb130-846" aria-hidden="true" tabindex="-1"></a><span class="co">#       address = c(</span></span>
<span id="cb130-847"><a href="#cb130-847" aria-hidden="true" tabindex="-1"></a><span class="co">#         "918 W Platt St # 1, Maquoketa, IA 52060",</span></span>
<span id="cb130-848"><a href="#cb130-848" aria-hidden="true" tabindex="-1"></a><span class="co">#         "3001 Douglas Blvd # 325, Roseville, CA 95661",</span></span>
<span id="cb130-849"><a href="#cb130-849" aria-hidden="true" tabindex="-1"></a><span class="co">#         "8687 Connecticut St, Merillville, IL 46410",</span></span>
<span id="cb130-850"><a href="#cb130-850" aria-hidden="true" tabindex="-1"></a><span class="co">#         "3901 Rainbow Blvd # Ms 4010, Kansas City, KS 66103",</span></span>
<span id="cb130-851"><a href="#cb130-851" aria-hidden="true" tabindex="-1"></a><span class="co">#         "209 Nw 8th St, Seminole, NM 79360",</span></span>
<span id="cb130-852"><a href="#cb130-852" aria-hidden="true" tabindex="-1"></a><span class="co">#         "729 Sunrise Ave #602, Roseville, CA 95661",</span></span>
<span id="cb130-853"><a href="#cb130-853" aria-hidden="true" tabindex="-1"></a><span class="co">#         "812 Pollard Rd # 5, Los Gatos, CA 95032",</span></span>
<span id="cb130-854"><a href="#cb130-854" aria-hidden="true" tabindex="-1"></a><span class="co">#         "365 Montauk Ave, New London, TN 06320"</span></span>
<span id="cb130-855"><a href="#cb130-855" aria-hidden="true" tabindex="-1"></a><span class="co">#       ),</span></span>
<span id="cb130-856"><a href="#cb130-856" aria-hidden="true" tabindex="-1"></a><span class="co">#       fips6 = c(</span></span>
<span id="cb130-857"><a href="#cb130-857" aria-hidden="true" tabindex="-1"></a><span class="co">#         "19097",</span></span>
<span id="cb130-858"><a href="#cb130-858" aria-hidden="true" tabindex="-1"></a><span class="co">#         "06061",</span></span>
<span id="cb130-859"><a href="#cb130-859" aria-hidden="true" tabindex="-1"></a><span class="co">#         "18089",</span></span>
<span id="cb130-860"><a href="#cb130-860" aria-hidden="true" tabindex="-1"></a><span class="co">#         "20209",</span></span>
<span id="cb130-861"><a href="#cb130-861" aria-hidden="true" tabindex="-1"></a><span class="co">#         "48165",</span></span>
<span id="cb130-862"><a href="#cb130-862" aria-hidden="true" tabindex="-1"></a><span class="co">#         "06085",</span></span>
<span id="cb130-863"><a href="#cb130-863" aria-hidden="true" tabindex="-1"></a><span class="co">#         "06085",</span></span>
<span id="cb130-864"><a href="#cb130-864" aria-hidden="true" tabindex="-1"></a><span class="co">#         "09011"</span></span>
<span id="cb130-865"><a href="#cb130-865" aria-hidden="true" tabindex="-1"></a><span class="co">#       )),</span></span>
<span id="cb130-866"><a href="#cb130-866" aria-hidden="true" tabindex="-1"></a><span class="co">#     by = join_by(address == address),</span></span>
<span id="cb130-867"><a href="#cb130-867" aria-hidden="true" tabindex="-1"></a><span class="co">#     relationship = "many-to-one")                            # left_join will not work without specifying this relation</span></span>
<span id="cb130-868"><a href="#cb130-868" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-869"><a href="#cb130-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-872"><a href="#cb130-872" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-873"><a href="#cb130-873" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: re_geocoding_4</span></span>
<span id="cb130-874"><a href="#cb130-874" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: FALSE</span></span>
<span id="cb130-875"><a href="#cb130-875" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: FALSE</span></span>
<span id="cb130-876"><a href="#cb130-876" aria-hidden="true" tabindex="-1"></a><span class="co"># for (query in unique(addresses[addresses$miss_state2 != 0,]$query2)) {</span></span>
<span id="cb130-877"><a href="#cb130-877" aria-hidden="true" tabindex="-1"></a><span class="co">#   addresses &lt;- left_join(addresses,      # x dataset</span></span>
<span id="cb130-878"><a href="#cb130-878" aria-hidden="true" tabindex="-1"></a><span class="co">#     geocode_combine(                     # y dataset</span></span>
<span id="cb130-879"><a href="#cb130-879" aria-hidden="true" tabindex="-1"></a><span class="co">#       addresses |&gt; filter(miss_state2 != 0 &amp; query2 == query),                                   </span></span>
<span id="cb130-880"><a href="#cb130-880" aria-hidden="true" tabindex="-1"></a><span class="co">#       queries = </span></span>
<span id="cb130-881"><a href="#cb130-881" aria-hidden="true" tabindex="-1"></a><span class="co">#         queries[queries[query == queries$service,]$i+1:nrow(queries),]$queries, </span></span>
<span id="cb130-882"><a href="#cb130-882" aria-hidden="true" tabindex="-1"></a><span class="co">#       cascade = TRUE) |&gt;                                                              </span></span>
<span id="cb130-883"><a href="#cb130-883" aria-hidden="true" tabindex="-1"></a><span class="co">#       select(address, lat, long, query),                                              </span></span>
<span id="cb130-884"><a href="#cb130-884" aria-hidden="true" tabindex="-1"></a><span class="co">#     by = join_by(address == address),</span></span>
<span id="cb130-885"><a href="#cb130-885" aria-hidden="true" tabindex="-1"></a><span class="co">#     relationship = "many-to-one")  |&gt;</span></span>
<span id="cb130-886"><a href="#cb130-886" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(fips2 = </span></span>
<span id="cb130-887"><a href="#cb130-887" aria-hidden="true" tabindex="-1"></a><span class="co">#     if_else(!is.na(query),               # update fips2 if new query is present</span></span>
<span id="cb130-888"><a href="#cb130-888" aria-hidden="true" tabindex="-1"></a><span class="co">#     coords_to_fips(x = long, y = lat),   # if present calculate new fips2 value</span></span>
<span id="cb130-889"><a href="#cb130-889" aria-hidden="true" tabindex="-1"></a><span class="co">#     fips2)) |&gt;                           # else keep old value</span></span>
<span id="cb130-890"><a href="#cb130-890" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(miss_state2 =                   # update miss_state2</span></span>
<span id="cb130-891"><a href="#cb130-891" aria-hidden="true" tabindex="-1"></a><span class="co">#     if_else(!is.na(query) &amp; (Prscrbr_State_Abrvtn == fips_abbr(fips2)),</span></span>
<span id="cb130-892"><a href="#cb130-892" aria-hidden="true" tabindex="-1"></a><span class="co">#     0, 1, missing = miss_state2)) |&gt;</span></span>
<span id="cb130-893"><a href="#cb130-893" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(query2 =                        # update query2 if there's a new one</span></span>
<span id="cb130-894"><a href="#cb130-894" aria-hidden="true" tabindex="-1"></a><span class="co">#     if_else(!is.na(query),               # check if there's a new query value</span></span>
<span id="cb130-895"><a href="#cb130-895" aria-hidden="true" tabindex="-1"></a><span class="co">#     query, query2)) |&gt;                   # update value; else keep old value</span></span>
<span id="cb130-896"><a href="#cb130-896" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(-lat, -long, -query)}</span></span>
<span id="cb130-897"><a href="#cb130-897" aria-hidden="true" tabindex="-1"></a><span class="co"># # cleanup</span></span>
<span id="cb130-898"><a href="#cb130-898" aria-hidden="true" tabindex="-1"></a><span class="co"># rm(query)</span></span>
<span id="cb130-899"><a href="#cb130-899" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb130-900"><a href="#cb130-900" aria-hidden="true" tabindex="-1"></a><span class="co"># # Diagnostics:</span></span>
<span id="cb130-901"><a href="#cb130-901" aria-hidden="true" tabindex="-1"></a><span class="co"># addresses |&gt;</span></span>
<span id="cb130-902"><a href="#cb130-902" aria-hidden="true" tabindex="-1"></a><span class="co">#   group_by(query2) |&gt;</span></span>
<span id="cb130-903"><a href="#cb130-903" aria-hidden="true" tabindex="-1"></a><span class="co">#   summarise(</span></span>
<span id="cb130-904"><a href="#cb130-904" aria-hidden="true" tabindex="-1"></a><span class="co">#     Missing_fips = sum(is.na(fips2)),</span></span>
<span id="cb130-905"><a href="#cb130-905" aria-hidden="true" tabindex="-1"></a><span class="co">#     Correct_State = sum(miss_state2 == 0),</span></span>
<span id="cb130-906"><a href="#cb130-906" aria-hidden="true" tabindex="-1"></a><span class="co">#     N = n()</span></span>
<span id="cb130-907"><a href="#cb130-907" aria-hidden="true" tabindex="-1"></a><span class="co">#   ) |&gt;</span></span>
<span id="cb130-908"><a href="#cb130-908" aria-hidden="true" tabindex="-1"></a><span class="co">#   arrange(desc(N)) |&gt;</span></span>
<span id="cb130-909"><a href="#cb130-909" aria-hidden="true" tabindex="-1"></a><span class="co">#   adorn_totals()</span></span>
<span id="cb130-910"><a href="#cb130-910" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-911"><a href="#cb130-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-912"><a href="#cb130-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-913"><a href="#cb130-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-916"><a href="#cb130-916" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-917"><a href="#cb130-917" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: geocoding_veryold</span></span>
<span id="cb130-918"><a href="#cb130-918" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: FALSE</span></span>
<span id="cb130-919"><a href="#cb130-919" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: FALSE</span></span>
<span id="cb130-920"><a href="#cb130-920" aria-hidden="true" tabindex="-1"></a>addresses <span class="ot">&lt;-</span> addresses <span class="sc">|&gt;</span></span>
<span id="cb130-921"><a href="#cb130-921" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geocode_combine</span>(</span>
<span id="cb130-922"><a href="#cb130-922" aria-hidden="true" tabindex="-1"></a>    <span class="at">queries =</span> queries<span class="sc">$</span>queries,</span>
<span id="cb130-923"><a href="#cb130-923" aria-hidden="true" tabindex="-1"></a>    <span class="at">cascade =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-924"><a href="#cb130-924" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Diagnostics: fips, state, and check if the state is correct</span></span>
<span id="cb130-925"><a href="#cb130-925" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fips2 =</span> <span class="fu">coords_to_fips</span>(<span class="at">x =</span> long, <span class="at">y =</span> lat)) <span class="sc">|&gt;</span></span>
<span id="cb130-926"><a href="#cb130-926" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">miss_state2 =</span> <span class="fu">if_else</span>(Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="fu">fips_abbr</span>(fips2),</span>
<span id="cb130-927"><a href="#cb130-927" aria-hidden="true" tabindex="-1"></a>                               <span class="dv">0</span>, <span class="dv">1</span>, <span class="at">missing =</span> <span class="dv">2</span>)) <span class="sc">|&gt;</span></span>
<span id="cb130-928"><a href="#cb130-928" aria-hidden="true" tabindex="-1"></a>  <span class="do">## rename/remove variables for next round of geocoding</span></span>
<span id="cb130-929"><a href="#cb130-929" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">query2 =</span> query) <span class="sc">|&gt;</span></span>
<span id="cb130-930"><a href="#cb130-930" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>lat, <span class="sc">-</span>long)</span>
<span id="cb130-931"><a href="#cb130-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-932"><a href="#cb130-932" aria-hidden="true" tabindex="-1"></a><span class="co"># Diagnostics:</span></span>
<span id="cb130-933"><a href="#cb130-933" aria-hidden="true" tabindex="-1"></a>addresses <span class="sc">|&gt;</span></span>
<span id="cb130-934"><a href="#cb130-934" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(query2) <span class="sc">|&gt;</span></span>
<span id="cb130-935"><a href="#cb130-935" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb130-936"><a href="#cb130-936" aria-hidden="true" tabindex="-1"></a>    <span class="at">Missing_fips =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(fips2)),</span>
<span id="cb130-937"><a href="#cb130-937" aria-hidden="true" tabindex="-1"></a>    <span class="at">Correct_State =</span> <span class="fu">sum</span>(miss_state2 <span class="sc">==</span> <span class="dv">0</span>),</span>
<span id="cb130-938"><a href="#cb130-938" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> <span class="fu">n</span>()</span>
<span id="cb130-939"><a href="#cb130-939" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb130-940"><a href="#cb130-940" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(N)) <span class="sc">|&gt;</span></span>
<span id="cb130-941"><a href="#cb130-941" aria-hidden="true" tabindex="-1"></a>  <span class="fu">adorn_totals</span>()</span>
<span id="cb130-942"><a href="#cb130-942" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>